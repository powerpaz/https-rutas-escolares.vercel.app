<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå Sistema de Rutas de Transporte Escolar - MINEDUC Ecuador</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --yellow: #fcd116;
            --blue: #003893;
            --red: #ce1126;
            --dark-bg: #0a1628;
            --card-bg: rgba(15, 30, 55, 0.95);
            --text-light: #e8f0ff;
            --text-muted: #8ba3c7;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a365d 50%, var(--dark-bg) 100%);
            min-height: 100vh;
            color: var(--text-light);
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, var(--yellow) 0%, var(--yellow) 33%, var(--blue) 33%, var(--blue) 66%, var(--red) 66%, var(--red) 100%);
            height: 6px;
        }

        .header-content {
            background: var(--card-bg);
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(252, 209, 22, 0.2);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section h1 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--yellow);
        }

        .logo-section span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--card-bg);
            border-right: 1px solid rgba(252, 209, 22, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--yellow);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed rgba(252, 209, 22, 0.4);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(252, 209, 22, 0.05);
        }

        .upload-area:hover {
            border-color: var(--yellow);
            background: rgba(252, 209, 22, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .upload-text strong {
            color: var(--yellow);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--yellow);
            color: var(--dark-bg);
        }

        .btn-primary:hover {
            background: #e5bc00;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--yellow);
            border: 1px solid var(--yellow);
        }

        .btn-secondary:hover {
            background: rgba(252, 209, 22, 0.1);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        /* Route List */
        .route-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .route-item {
            background: rgba(252, 209, 22, 0.05);
            border: 1px solid rgba(252, 209, 22, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .route-item:hover {
            border-color: var(--yellow);
            background: rgba(252, 209, 22, 0.1);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .route-number {
            font-weight: 600;
            color: var(--yellow);
        }

        .route-delete {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .route-delete:hover {
            background: rgba(206, 17, 38, 0.2);
        }

        .route-info {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .route-info span {
            display: block;
            margin-bottom: 3px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: rgba(252, 209, 22, 0.08);
            border: 1px solid rgba(252, 209, 22, 0.2);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--yellow);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Map */
        #map {
            width: 100%;
            height: 100%;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            border: 1px solid rgba(252, 209, 22, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--yellow);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--red);
        }

        /* Form */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(252, 209, 22, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .coord-section {
            background: rgba(252, 209, 22, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .coord-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coord-origin {
            border-left: 3px solid var(--yellow);
        }

        .coord-dest {
            border-left: 3px solid var(--success);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .export-buttons .btn {
            flex: 1;
        }

        /* IE Info */
        .ie-info {
            background: rgba(252, 209, 22, 0.1);
            border: 1px solid rgba(252, 209, 22, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ie-info h3 {
            font-size: 0.9rem;
            color: var(--yellow);
            margin-bottom: 8px;
        }

        .ie-info p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        /* Leaflet custom */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text-light);
            border-radius: 10px;
            border: 1px solid rgba(252, 209, 22, 0.3);
        }

        .leaflet-popup-tip {
            background: var(--card-bg);
        }

        .custom-marker {
            background: var(--yellow);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(252, 209, 22, 0.2);
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 15px;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="header"></div>
    <div class="header-content">
        <div class="logo-section">
            <h1>üöå Sistema de Rutas de Transporte Escolar</h1>
            <span>Ministerio de Educaci√≥n - Ecuador</span>
        </div>
        <div class="export-buttons">
            <button class="btn btn-secondary" onclick="centerMap()">üìç Centrar Mapa</button>
            <button class="btn btn-primary" onclick="exportToJPG()">üì∑ Exportar JPG</button>
            <button class="btn btn-success" onclick="exportToPDF()">üìÑ Exportar PDF</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- Upload Section -->
            <div class="section">
                <div class="section-title">üìÅ Cargar Archivo Excel</div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xlsm,.xls,.csv">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">
                        <strong>Arrastra y suelta</strong> tu archivo Excel aqu√≠<br>
                        o <strong>haz clic</strong> para seleccionar
                    </div>
                </div>
            </div>

            <!-- IE Eje Info -->
            <div class="section" id="ieInfoSection" style="display: none;">
                <div class="ie-info">
                    <h3>üè´ Instituci√≥n Educativa Eje</h3>
                    <p id="ieNombre">-</p>
                    <p id="ieAmie">AMIE: -</p>
                    <p id="ieDistrito">Distrito: -</p>
                    <p id="ieCoords">Coordenadas: -</p>
                </div>
            </div>

            <!-- Manual Route -->
            <div class="section">
                <div class="section-title">‚ûï Agregar Ruta Manual</div>
                <button class="btn btn-primary btn-block" onclick="openModal()">
                    üó∫Ô∏è Nueva Ruta de Transporte
                </button>
            </div>

            <!-- Route List -->
            <div class="section">
                <div class="section-title">üìã Rutas de Transporte (<span id="routeCount">0</span>)</div>
                <div class="route-list" id="routeList">
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üõ£Ô∏è</div>
                        <div>No hay rutas cargadas</div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="section">
                <div class="section-title">üìä Estad√≠sticas</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRoutes">0</div>
                        <div class="stat-label">Rutas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Estudiantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDistance">0</div>
                        <div class="stat-label">Km Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalIE">0</div>
                        <div class="stat-label">IE Origen</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="section">
                <button class="btn btn-danger btn-block" onclick="clearAll()">
                    üóëÔ∏è Limpiar Todo
                </button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">üó∫Ô∏è Agregar Nueva Ruta</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="routeForm" onsubmit="addManualRoute(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">N√∫mero de Ruta</label>
                        <input type="text" class="form-input" id="routeNumber" placeholder="Ej: 1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Beneficiarios</label>
                        <input type="number" class="form-input" id="routeBeneficiaries" placeholder="Ej: 50" required>
                    </div>
                </div>

                <div class="coord-section coord-origin">
                    <div class="coord-section-title">
                        <span style="color: var(--yellow);">üìç</span> Origen (IE Fusionada/Cerrada)
                    </div>
                    <div class="form-group">
                        <label class="form-label">C√≥digo AMIE</label>
                        <input type="text" class="form-input" id="originAmie" placeholder="Ej: 17H02596">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coordenada X (UTM)</label>
                            <input type="text" class="form-input" id="originX" placeholder="Ej: 686181.37" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordenada Y (UTM)</label>
                            <input type="text" class="form-input" id="originY" placeholder="Ej: 10024104.72" required>
                        </div>
                    </div>
                </div>

                <div class="coord-section coord-dest">
                    <div class="coord-section-title">
                        <span style="color: var(--success);">üè´</span> Destino (IE Eje)
                    </div>
                    <div class="form-group">
                        <label class="form-label">C√≥digo AMIE</label>
                        <input type="text" class="form-input" id="destAmie" placeholder="Ej: 17H02577">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coordenada X (UTM)</label>
                            <input type="text" class="form-input" id="destX" placeholder="Ej: 687783.43" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordenada Y (UTM)</label>
                            <input type="text" class="form-input" id="destY" placeholder="Ej: 10022986.7" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Distancia (Km)</label>
                        <input type="text" class="form-input" id="routeDistance" placeholder="Ej: 2.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Transporte</label>
                        <select class="form-input" id="routeTransport">
                            <option value="BUS">Bus</option>
                            <option value="FURGONETA">Furgoneta</option>
                            <option value="MINI BUS">Mini Bus</option>
                            <option value="MICRO BUS">Micro Bus</option>
                            <option value="CAMIONETA">Camioneta</option>
                            <option value="FLUVIAL">Fluvial</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">
                    ‚úÖ Agregar Ruta al Mapa
                </button>
            </form>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Procesando...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const CONFIG = {
            UTM_ZONE: 17,
            SOUTHERN_HEMISPHERE: true,
            DEFAULT_CENTER: [-0.1807, -78.4678], // Quito
            DEFAULT_ZOOM: 8
        };

        // ==================== VARIABLES GLOBALES ====================
        let map;
        let routes = [];
        let markers = [];
        let polylines = [];
        let ieEje = null;
        let routeColors = [
            '#fcd116', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'
        ];

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initFileUpload();
        });

        function initMap() {
            map = L.map('map').setView(CONFIG.DEFAULT_CENTER, CONFIG.DEFAULT_ZOOM);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | MINEDUC Ecuador'
            }).addTo(map);
        }

        function initFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            });
        }

        // ==================== CONVERSI√ìN UTM A LAT/LON ====================
        function utmToLatLon(x, y, zone = CONFIG.UTM_ZONE, southern = CONFIG.SOUTHERN_HEMISPHERE) {
            // Constantes WGS84
            const a = 6378137.0;
            const f = 1 / 298.257223563;
            const k0 = 0.9996;
            
            const e = Math.sqrt(2 * f - f * f);
            const e2 = e * e;
            const e_prime2 = e2 / (1 - e2);
            
            const x_adj = x - 500000;
            const y_adj = southern ? y - 10000000 : y;
            
            const M = y_adj / k0;
            const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
            
            const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
            
            const phi1 = mu + (3*e1/2 - 27*e1*e1*e1/32) * Math.sin(2*mu)
                           + (21*e1*e1/16 - 55*e1*e1*e1*e1/32) * Math.sin(4*mu)
                           + (151*e1*e1*e1/96) * Math.sin(6*mu);
            
            const N1 = a / Math.sqrt(1 - e2 * Math.sin(phi1) * Math.sin(phi1));
            const T1 = Math.tan(phi1) * Math.tan(phi1);
            const C1 = e_prime2 * Math.cos(phi1) * Math.cos(phi1);
            const R1 = a * (1 - e2) / Math.pow(1 - e2 * Math.sin(phi1) * Math.sin(phi1), 1.5);
            const D = x_adj / (N1 * k0);
            
            let lat = phi1 - (N1 * Math.tan(phi1) / R1) * (
                D * D / 2
                - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*e_prime2) * D*D*D*D / 24
                + (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*e_prime2 - 3*C1*C1) * D*D*D*D*D*D / 720
            );
            
            const lon0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;
            let lon = lon0 + (
                D
                - (1 + 2*T1 + C1) * D*D*D / 6
                + (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*e_prime2 + 24*T1*T1) * D*D*D*D*D / 120
            ) / Math.cos(phi1);
            
            lat = lat * 180 / Math.PI;
            lon = lon * 180 / Math.PI;
            
            return { lat, lon };
        }

        // ==================== PROCESAMIENTO DE ARCHIVOS ====================
        async function processFile(file) {
            showLoading(true);
            
            try {
                const data = await readExcelFile(file);
                parseExcelData(data);
                showNotification('Archivo cargado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al procesar el archivo: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Error al leer archivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        function parseExcelData(workbook) {
            // Buscar hoja RUTA
            let sheetName = workbook.SheetNames.find(name => 
                name.toUpperCase().includes('RUTA')
            ) || workbook.SheetNames[0];
            
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            console.log('Datos Excel:', jsonData.slice(0, 15));
            
            // Extraer informaci√≥n de IE Eje
            extractIEEje(jsonData);
            
            // Extraer rutas
            extractRoutes(jsonData);
            
            // Actualizar UI
            updateUI();
            centerMap();
        }

        function extractIEEje(data) {
            ieEje = {
                nombre: '',
                amie: '',
                distrito: '',
                x: null,
                y: null
            };

            // Buscar en las primeras filas
            for (let i = 0; i < Math.min(10, data.length); i++) {
                const row = data[i];
                if (!row) continue;

                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toUpperCase();
                    
                    if (cell.includes('AMIE') && cell.includes('EJE')) {
                        ieEje.amie = row[j + 1] || '';
                    }
                    if (cell.includes('NOMBRE') && cell.includes('EDUCATIVA') && cell.includes('EJE')) {
                        ieEje.nombre = row[j + 1] || '';
                    }
                    if (cell.includes('NOMBRE') && cell.includes('DISTRITO')) {
                        ieEje.distrito = row[j + 1] || '';
                    }
                    if (cell === 'COORDENADA X' || cell === 'COORDENADAS X') {
                        const val = parseFloat(row[j + 1]);
                        if (!isNaN(val) && val > 100000) ieEje.x = val;
                    }
                    if (cell === 'COORDENADAS Y' || cell === 'COORDENADA Y') {
                        const val = parseFloat(row[j + 1]);
                        if (!isNaN(val) && val > 100000) ieEje.y = val;
                    }
                }
            }

            console.log('IE Eje encontrada:', ieEje);

            // Actualizar UI
            if (ieEje.nombre || ieEje.amie) {
                document.getElementById('ieInfoSection').style.display = 'block';
                document.getElementById('ieNombre').textContent = ieEje.nombre || '-';
                document.getElementById('ieAmie').textContent = 'AMIE: ' + (ieEje.amie || '-');
                document.getElementById('ieDistrito').textContent = 'Distrito: ' + (ieEje.distrito || '-');
                
                if (ieEje.x && ieEje.y) {
                    const coords = utmToLatLon(ieEje.x, ieEje.y);
                    document.getElementById('ieCoords').textContent = 
                        `Lat: ${coords.lat.toFixed(6)}, Lon: ${coords.lon.toFixed(6)}`;
                }
            }
        }

        function extractRoutes(data) {
            // Encontrar fila de encabezados
            let headerRow = -1;
            let colIndices = {};

            for (let i = 0; i < Math.min(15, data.length); i++) {
                const row = data[i];
                if (!row) continue;

                const rowStr = row.join(' ').toUpperCase();
                if (rowStr.includes('RUTA') && rowStr.includes('COORDENADA')) {
                    headerRow = i;
                    
                    // Mapear columnas
                    row.forEach((cell, idx) => {
                        const cellStr = String(cell || '').toUpperCase().trim();
                        if (cellStr === 'RUTA') colIndices.ruta = idx;
                        if (cellStr.includes('AMIE') && cellStr.includes('EJE') && !cellStr.includes('FUSIONADA')) colIndices.amieEje = idx;
                        if (cellStr.includes('AMIE') && (cellStr.includes('FUSIONADA') || cellStr.includes('COMUNIDAD'))) colIndices.amieFusionada = idx;
                        if (cellStr.includes('BENEFICIARIOS') && cellStr.includes('RUTA')) colIndices.beneficiarios = idx;
                        if (cellStr.includes('DISTANCIA') && cellStr.includes('RUTA')) colIndices.distancia = idx;
                        if (cellStr === 'COORDENADA X') colIndices.x = idx;
                        if (cellStr === 'COORDENADA Y') colIndices.y = idx;
                    });
                    break;
                }
            }

            console.log('Header row:', headerRow, 'Columnas:', colIndices);

            if (headerRow === -1) {
                showNotification('No se encontr√≥ formato de rutas v√°lido', 'error');
                return;
            }

            // Limpiar rutas anteriores
            clearRoutes();

            // Extraer datos de rutas
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[colIndices.ruta]) continue;

                const routeNum = row[colIndices.ruta];
                if (isNaN(routeNum)) continue;

                const x = parseFloat(row[colIndices.x]);
                const y = parseFloat(row[colIndices.y]);

                if (isNaN(x) || isNaN(y) || x < 100 || y < 100) continue;

                const route = {
                    id: Date.now() + Math.random(),
                    numero: routeNum,
                    amieEje: row[colIndices.amieEje] || ieEje.amie || '',
                    amieFusionada: row[colIndices.amieFusionada] || '',
                    beneficiarios: parseInt(row[colIndices.beneficiarios]) || 0,
                    distancia: parseFloat(row[colIndices.distancia]) || 0,
                    origen: { x, y },
                    destino: { x: ieEje.x, y: ieEje.y }
                };

                routes.push(route);
                drawRoute(route);
            }

            console.log('Rutas extra√≠das:', routes.length);
        }

        // ==================== DIBUJO EN MAPA ====================
        function drawRoute(route) {
            const colorIndex = (routes.indexOf(route) || 0) % routeColors.length;
            const color = routeColors[colorIndex];

            // Convertir coordenadas
            const originLatLon = utmToLatLon(route.origen.x, route.origen.y);
            const destLatLon = route.destino.x && route.destino.y 
                ? utmToLatLon(route.destino.x, route.destino.y)
                : originLatLon;

            // Marcador de origen (IE Fusionada)
            const originIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background: ${color}; width: 28px; height: 28px; border-radius: 50%; 
                       display: flex; align-items: center; justify-content: center; font-size: 14px;
                       border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            const originMarker = L.marker([originLatLon.lat, originLatLon.lon], { icon: originIcon })
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0; color: #fcd116;">üìç Ruta ${route.numero}</h4>
                        <p style="margin: 4px 0; font-size: 12px;"><b>AMIE:</b> ${route.amieFusionada}</p>
                        <p style="margin: 4px 0; font-size: 12px;"><b>Beneficiarios:</b> ${route.beneficiarios}</p>
                        <p style="margin: 4px 0; font-size: 12px;"><b>Distancia:</b> ${route.distancia} km</p>
                        <p style="margin: 4px 0; font-size: 11px; color: #8ba3c7;">
                            UTM: ${route.origen.x.toFixed(2)}, ${route.origen.y.toFixed(2)}
                        </p>
                    </div>
                `)
                .addTo(map);

            markers.push(originMarker);

            // Marcador de destino (IE Eje) - solo si tiene coordenadas
            if (route.destino.x && route.destino.y) {
                const destIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background: #10b981; width: 32px; height: 32px; border-radius: 50%; 
                           display: flex; align-items: center; justify-content: center; font-size: 16px;
                           border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üè´</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                // Solo agregar marcador de destino si no existe ya
                const existingDest = markers.find(m => {
                    const pos = m.getLatLng();
                    return Math.abs(pos.lat - destLatLon.lat) < 0.0001 && 
                           Math.abs(pos.lng - destLatLon.lon) < 0.0001;
                });

                if (!existingDest) {
                    const destMarker = L.marker([destLatLon.lat, destLatLon.lon], { icon: destIcon })
                        .bindPopup(`
                            <div style="min-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: #10b981;">üè´ IE Eje</h4>
                                <p style="margin: 4px 0; font-size: 12px;"><b>Nombre:</b> ${ieEje.nombre || '-'}</p>
                                <p style="margin: 4px 0; font-size: 12px;"><b>AMIE:</b> ${ieEje.amie || route.amieEje}</p>
                            </div>
                        `)
                        .addTo(map);
                    markers.push(destMarker);
                }

                // L√≠nea de ruta
                const polyline = L.polyline(
                    [[originLatLon.lat, originLatLon.lon], [destLatLon.lat, destLatLon.lon]],
                    {
                        color: color,
                        weight: 3,
                        opacity: 0.8,
                        dashArray: '10, 10'
                    }
                ).bindPopup(`
                    <div>
                        <b>Ruta ${route.numero}</b><br>
                        Distancia: ${route.distancia} km<br>
                        Beneficiarios: ${route.beneficiarios}
                    </div>
                `).addTo(map);

                polylines.push(polyline);
            }
        }

        // ==================== FUNCIONES UI ====================
        function updateUI() {
            // Lista de rutas
            const routeList = document.getElementById('routeList');
            
            if (routes.length === 0) {
                routeList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üõ£Ô∏è</div>
                        <div>No hay rutas cargadas</div>
                    </div>
                `;
            } else {
                routeList.innerHTML = routes.map((route, idx) => `
                    <div class="route-item">
                        <div class="route-header">
                            <span class="route-number" style="color: ${routeColors[idx % routeColors.length]}">
                                üöå Ruta ${route.numero}
                            </span>
                            <button class="route-delete" onclick="deleteRoute('${route.id}')">‚úï</button>
                        </div>
                        <div class="route-info">
                            <span>üìç AMIE: ${route.amieFusionada || '-'}</span>
                            <span>üë• Beneficiarios: ${route.beneficiarios}</span>
                            <span>üìè Distancia: ${route.distancia} km</span>
                        </div>
                    </div>
                `).join('');
            }

            // Contadores
            document.getElementById('routeCount').textContent = routes.length;
            document.getElementById('totalRoutes').textContent = routes.length;
            document.getElementById('totalStudents').textContent = routes.reduce((sum, r) => sum + r.beneficiarios, 0);
            document.getElementById('totalDistance').textContent = routes.reduce((sum, r) => sum + r.distancia, 0).toFixed(1);
            document.getElementById('totalIE').textContent = new Set(routes.map(r => r.amieFusionada)).size;
        }

        function deleteRoute(id) {
            routes = routes.filter(r => r.id != id);
            redrawMap();
            updateUI();
            showNotification('Ruta eliminada', 'info');
        }

        function clearRoutes() {
            markers.forEach(m => map.removeLayer(m));
            polylines.forEach(p => map.removeLayer(p));
            markers = [];
            polylines = [];
        }

        function redrawMap() {
            clearRoutes();
            routes.forEach(route => drawRoute(route));
        }

        function clearAll() {
            if (confirm('¬øEst√° seguro de eliminar todas las rutas?')) {
                routes = [];
                ieEje = null;
                clearRoutes();
                updateUI();
                document.getElementById('ieInfoSection').style.display = 'none';
                showNotification('Todo limpiado', 'info');
            }
        }

        function centerMap() {
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // ==================== MODAL ====================
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
            
            // Pre-llenar destino si tenemos IE Eje
            if (ieEje) {
                document.getElementById('destAmie').value = ieEje.amie || '';
                document.getElementById('destX').value = ieEje.x || '';
                document.getElementById('destY').value = ieEje.y || '';
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function addManualRoute(event) {
            event.preventDefault();

            const route = {
                id: Date.now(),
                numero: document.getElementById('routeNumber').value,
                amieFusionada: document.getElementById('originAmie').value,
                amieEje: document.getElementById('destAmie').value,
                beneficiarios: parseInt(document.getElementById('routeBeneficiaries').value) || 0,
                distancia: parseFloat(document.getElementById('routeDistance').value) || 0,
                transporte: document.getElementById('routeTransport').value,
                origen: {
                    x: parseFloat(document.getElementById('originX').value),
                    y: parseFloat(document.getElementById('originY').value)
                },
                destino: {
                    x: parseFloat(document.getElementById('destX').value),
                    y: parseFloat(document.getElementById('destY').value)
                }
            };

            if (isNaN(route.origen.x) || isNaN(route.origen.y)) {
                showNotification('Coordenadas de origen inv√°lidas', 'error');
                return;
            }

            routes.push(route);
            drawRoute(route);
            updateUI();
            closeModal();
            document.getElementById('routeForm').reset();
            showNotification('Ruta agregada correctamente', 'success');
            centerMap();
        }

        // ==================== EXPORTACI√ìN ====================
        async function exportToJPG() {
            showLoading(true);
            
            try {
                const mapElement = document.getElementById('map');
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2
                });

                const link = document.createElement('a');
                link.download = `rutas_transporte_${ieEje?.amie || 'mapa'}_${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();

                showNotification('Mapa exportado como JPG', 'success');
            } catch (error) {
                console.error('Error exportando JPG:', error);
                showNotification('Error al exportar JPG', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportToPDF() {
            showLoading(true);
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                // Header con colores de Ecuador
                doc.setFillColor(252, 209, 22);
                doc.rect(0, 0, 297, 8, 'F');
                
                doc.setFillColor(0, 56, 147);
                doc.rect(0, 8, 297, 3, 'F');
                
                doc.setFillColor(206, 17, 38);
                doc.rect(0, 11, 297, 2, 'F');

                // T√≠tulo
                doc.setFontSize(18);
                doc.setTextColor(0, 56, 147);
                doc.text('INFORME DE RUTAS DE TRANSPORTE ESCOLAR', 148.5, 25, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Ministerio de Educaci√≥n - Ecuador', 148.5, 32, { align: 'center' });

                // Informaci√≥n IE Eje
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                let yPos = 45;

                if (ieEje) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Instituci√≥n Educativa Eje:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(ieEje.nombre || '-', 80, yPos);
                    yPos += 7;
                    doc.text(`AMIE: ${ieEje.amie || '-'}`, 20, yPos);
                    doc.text(`Distrito: ${ieEje.distrito || '-'}`, 120, yPos);
                }

                // Estad√≠sticas
                yPos += 15;
                doc.setFont(undefined, 'bold');
                doc.text('Resumen:', 20, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 7;
                
                const stats = [
                    `Total de Rutas: ${routes.length}`,
                    `Total de Beneficiarios: ${routes.reduce((s, r) => s + r.beneficiarios, 0)}`,
                    `Distancia Total: ${routes.reduce((s, r) => s + r.distancia, 0).toFixed(2)} km`,
                    `Fecha: ${new Date().toLocaleDateString('es-EC')}`
                ];
                
                stats.forEach(stat => {
                    doc.text(stat, 25, yPos);
                    yPos += 6;
                });

                // Capturar mapa
                const mapElement = document.getElementById('map');
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                doc.addImage(imgData, 'JPEG', 20, yPos + 5, 180, 100);

                // Tabla de rutas
                yPos = yPos + 110;
                if (yPos > 180) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFont(undefined, 'bold');
                doc.text('Detalle de Rutas:', 20, yPos);
                yPos += 8;

                // Encabezados de tabla
                doc.setFillColor(0, 56, 147);
                doc.setTextColor(255, 255, 255);
                doc.rect(20, yPos - 4, 257, 8, 'F');
                
                doc.setFontSize(9);
                doc.text('Ruta', 25, yPos);
                doc.text('AMIE Origen', 50, yPos);
                doc.text('Beneficiarios', 110, yPos);
                doc.text('Distancia (km)', 150, yPos);
                doc.text('Coordenadas UTM', 200, yPos);
                
                yPos += 8;
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');

                routes.slice(0, 15).forEach((route, idx) => {
                    if (idx % 2 === 0) {
                        doc.setFillColor(245, 245, 245);
                        doc.rect(20, yPos - 4, 257, 7, 'F');
                    }
                    
                    doc.text(String(route.numero), 25, yPos);
                    doc.text(route.amieFusionada || '-', 50, yPos);
                    doc.text(String(route.beneficiarios), 115, yPos);
                    doc.text(route.distancia.toFixed(2), 155, yPos);
                    doc.text(`${route.origen.x.toFixed(0)}, ${route.origen.y.toFixed(0)}`, 200, yPos);
                    
                    yPos += 7;
                    
                    if (yPos > 190) {
                        doc.addPage();
                        yPos = 20;
                    }
                });

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Generado el ${new Date().toLocaleString('es-EC')} | P√°gina ${i} de ${pageCount}`,
                        148.5, 205, { align: 'center' }
                    );
                }

                doc.save(`informe_transporte_${ieEje?.amie || 'rutas'}_${new Date().toISOString().slice(0,10)}.pdf`);
                showNotification('PDF generado correctamente', 'success');
                
            } catch (error) {
                console.error('Error exportando PDF:', error);
                showNotification('Error al generar PDF', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== UTILIDADES ====================
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>

<script>
// ==================== BACKEND DE RUTAS (VERCEL) ====================
const BACKEND_URL = 'https://rutas-escolares.vercel.app/api/route';

// Esta versi√≥n de drawRoute usa el backend en Vercel para calcular la ruta vial real.
// Sobrescribe cualquier definici√≥n anterior de drawRoute.
async function drawRoute(route) {
    try {
        const colorIndex = (routes.indexOf(route) || 0) % routeColors.length;
        const color = routeColors[colorIndex];

        // Conversi√≥n UTM -> WGS84 solo para mostrar los marcadores en el mapa
        const originLatLon = utmToLatLon(route.origen.x, route.origen.y);
        const destLatLon = (route.destino && route.destino.x && route.destino.y)
            ? utmToLatLon(route.destino.x, route.destino.y)
            : null;

        if (!destLatLon) {
            if (typeof showNotification === 'function') {
                showNotification('La IE eje no tiene coordenadas v√°lidas', 'error');
            }
            return;
        }

        if (typeof showLoading === 'function') {
            showLoading(true);
        }

        const resp = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                origin: { x: route.origen.x, y: route.origen.y },
                dest:   { x: route.destino.x, y: route.destino.y }
            })
        });

        const data = await resp.json();

        if (!resp.ok) {
            throw new Error(data.error || "Error al calcular ruta en servidor");
        }

        // Coordenadas devueltas por el backend (ya en lat/lon)
        const leafletCoords = data.coords.map(c => [c.lat, c.lon]);

        const polyline = L.polyline(leafletCoords, {
            color,
            weight: 5,
            opacity: 0.9
        }).addTo(map);

        if (typeof polylines !== 'undefined') {
            polylines.push(polyline);
        }

        // Marcadores de origen y destino (usamos nuestra conversi√≥n local UTM -> WGS84)
        const originMarker = L.circleMarker(
            [originLatLon.lat, originLatLon.lon],
            { radius: 6, color, fillColor: color, fillOpacity: 1 }
        ).addTo(map);

        const destMarker = L.circleMarker(
            [destLatLon.lat, destLatLon.lon],
            { radius: 6, color: "#ffffff", fillColor: color, fillOpacity: 1 }
        ).addTo(map);

        if (typeof markers !== 'undefined') {
            markers.push(originMarker, destMarker);
        }

        // Actualizar distancia en la ruta si no viene del Excel
        if (!route.distancia || route.distancia <= 0) {
            route.distancia = parseFloat(data.distance_km);
        }

        if (typeof showNotification === 'function') {
            showNotification(
                `Ruta ${route.numero} calculada: ${parseFloat(data.distance_km).toFixed(2)} km (‚âà ${data.duration_min} min)`,
                'success'
            );
        }
        if (typeof updateUI === 'function') {
            updateUI();
        }

    } catch (err) {
        console.error(err);
        if (typeof showNotification === 'function') {
            showNotification('No se pudo calcular la ruta en OSM: ' + err.message, 'error');
        }
    } finally {
        if (typeof showLoading === 'function') {
            showLoading(false);
        }
    }
}
</script>
</body>
</html>
