<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå Sistema de Rutas de Transporte Escolar - MINEDUC Ecuador</title>

    <!-- Aqu√≠ s√≠ van scripts y css del plugin -->
    <script src="latlontools/leaflet.latlontools.js"></script>
    <link rel="stylesheet" href="latlontools/leaflet.latlontools.css">
</head>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        .utm-box {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #0e1e36;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ffd33d;
    margin-left: 20px;
}

.utm-box input {
    background: #102544;
    border: 1px solid #ffd33d;
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    width: 145px;
}

.utm-box button {
    background: #ffd33d;
    color: #000;
    border: none;
    padding: 4px 10px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
}

#utmResult {
    color: #fff;
    margin-left: 10px;
}

        :root {
            --yellow: #fcd116;
            --blue: #003893;
            --red: #ce1126;
            --dark-bg: #0a1628;
            --card-bg: rgba(15, 30, 55, 0.95);
            --text-light: #e8f0ff;
            --text-muted: #8ba3c7;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a365d 50%, var(--dark-bg) 100%);
            min-height: 100vh;
            color: var(--text-light);
        }

        .header {
            background: linear-gradient(90deg, var(--yellow) 0%, var(--yellow) 33%, var(--blue) 33%, var(--blue) 66%, var(--red) 66%, var(--red) 100%);
            height: 6px;
        }

        .header-content {
            background: var(--card-bg);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(252, 209, 22, 0.2);
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo-section h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--yellow);
        }

        .logo-section span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 70px);
        }

        .sidebar {
            background: var(--card-bg);
            border-right: 1px solid rgba(252, 209, 22, 0.2);
            overflow-y: auto;
            padding: 15px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--yellow);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed rgba(252, 209, 22, 0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(252, 209, 22, 0.05);
        }

        .upload-area:hover {
            border-color: var(--yellow);
            background: rgba(252, 209, 22, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-area input[type="file"] { display: none; }
        .upload-icon { font-size: 2rem; margin-bottom: 8px; }
        .upload-text { font-size: 0.8rem; color: var(--text-muted); }
        .upload-text strong { color: var(--yellow); }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.8rem;
        }

        .btn-primary { background: var(--yellow); color: var(--dark-bg); }
        .btn-primary:hover { background: #e5bc00; }
        .btn-secondary { background: transparent; color: var(--yellow); border: 1px solid var(--yellow); }
        .btn-secondary:hover { background: rgba(252, 209, 22, 0.1); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--red); color: white; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }

        #map { width: 100%; height: 100%; }

        .ie-info {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 12px;
        }

        .ie-info h3 { color: var(--success); font-size: 0.85rem; margin-bottom: 8px; }
        .ie-info p { font-size: 0.75rem; color: var(--text-muted); margin: 4px 0; }
        .ie-info .coords { font-family: monospace; font-size: 0.7rem; color: var(--yellow); }

        .route-list { max-height: 280px; overflow-y: auto; }

        .route-item {
            background: rgba(252, 209, 22, 0.05);
            border: 1px solid rgba(252, 209, 22, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .route-item:hover {
            border-color: var(--yellow);
            background: rgba(252, 209, 22, 0.1);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .route-number { font-weight: 600; font-size: 0.9rem; }

        .route-mode-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.6);
            color: #a7f3d0;
        }

        .route-actions { display: flex; gap: 4px; }

        .route-delete {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
        }

        .route-info { font-size: 0.7rem; color: var(--text-muted); }
        .route-info span { display: block; margin-bottom: 2px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: rgba(252, 209, 22, 0.08);
            border: 1px solid rgba(252, 209, 22, 0.2);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .stat-value { font-size: 1.3rem; font-weight: 700; color: var(--yellow); }
        .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(252, 209, 22, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title { font-size: 1.1rem; font-weight: 600; color: var(--yellow); }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(252, 209, 22, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
        }

        .form-input:focus { outline: none; border-color: var(--yellow); }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .coord-section {
            background: rgba(252, 209, 22, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid var(--yellow);
        }

        .coord-section.coord-dest {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .coord-section-title { font-size: 0.8rem; font-weight: 600; margin-bottom: 10px; }

        .loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading.show { opacity: 1; visibility: visible; }

        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(252, 209, 22, 0.2);
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { margin-top: 15px; color: var(--text-light); }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-size: 0.85rem;
            z-index: 3001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

        .drawing-toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3500;
            background: rgba(15, 30, 55, 0.98);
            border-radius: 12px;
            border: 2px solid var(--yellow);
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.6);
        }

        .drawing-toolbar span { color: var(--yellow); font-weight: 600; }
        .drawing-toolbar .hint { color: var(--text-muted); font-size: 0.7rem; font-weight: normal; }

        .debug-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--yellow);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.65rem;
            color: #0f0;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-panel.show { display: block; }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { max-height: 45vh; }
        }
    </style>
</head>
<body>
<header class="topbar">
    <div class="topbar-left">
        <h1 class="app-title">üöå Rutas de Transporte Escolar</h1>

        <!-- üîµ √öNICO toolbox, corregido -->
        <div id="utm-toolbox" class="utm-box">
            <input type="text" id="inputUTM" placeholder="UTM 17S..." />
            <button onclick="convertUTM()">OK</button>
            <span id="utmResult"></span>
        </div>
    </div>

    <!-- Aqu√≠ puedes tener otros botones -->
    <div class="topbar-right">
        <button onclick="centerMap()">üìç Centrar</button>
        <button onclick="debug()">üîß Debug</button>
        <button onclick="exportJPG()">üñº JPG</button>
    </div>
</header>

    <div class="header"></div>

    <div class="header-content">
        <div class="logo-section">
            <h1>üöå Rutas de Transporte Escolar</h1>
            <span>MINEDUC Ecuador</span>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-secondary" onclick="centerMap()">üìç Centrar</button>
            <button class="btn btn-secondary" onclick="toggleDebug()">üîß Debug</button>
            <button class="btn btn-primary" onclick="exportToJPG()">üì∑ JPG</button>
            <button class="btn btn-success" onclick="exportToPDF()">üìÑ PDF</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="section">
                <div class="section-title">üìÅ Cargar Excel (Hoja RUTA)</div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xlsm,.xls">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">
                        <strong>Arrastra</strong> tu archivo Excel<br>
                        o <strong>haz clic</strong> para seleccionar
                    </div>
                </div>
                <div class="debug-panel" id="debugPanel"></div>
            </div>

            <div class="section" id="ieInfoSection" style="display:none;">
                <div class="ie-info">
                    <h3>üè´ IE Eje (Destino)</h3>
                    <p id="ieNombre">-</p>
                    <p id="ieAmie">AMIE: -</p>
                    <p id="ieDistrito">Distrito: -</p>
                    <p class="coords" id="ieCoords">Coordenadas: -</p>
                </div>
            </div>

            <div class="section">
                <div class="section-title">‚ûï Agregar Ruta Manual</div>
                <button class="btn btn-primary btn-block" onclick="openModal()">
                    üó∫Ô∏è Nueva Ruta
                </button>
            </div>

            <div class="section">
                <div class="section-title">
                    üìã Rutas (<span id="routeCount">0</span>)
                </div>
                <div class="route-list" id="routeList">
                    <div style="text-align:center; padding:25px; color:var(--text-muted);">
                        <div style="font-size:2rem; margin-bottom:8px;">üõ£Ô∏è</div>
                        <div>No hay rutas cargadas</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä Estad√≠sticas</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRoutes">0</div>
                        <div class="stat-label">Rutas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Estudiantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDistance">0</div>
                        <div class="stat-label">Km Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalIE">0</div>
                        <div class="stat-label">IE Origen</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-danger btn-block" onclick="clearAll()">
                    üóëÔ∏è Limpiar Todo
                </button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">üó∫Ô∏è Nueva Ruta</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>

            <form id="routeForm" onsubmit="addManualRoute(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">N√∫mero de Ruta *</label>
                        <input type="text" class="form-input" id="routeNumber" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Beneficiarios *</label>
                        <input type="number" class="form-input" id="routeBeneficiaries" required>
                    </div>
                </div>

                <div class="coord-section">
                    <div class="coord-section-title">üìç Origen (IE Fusionada/Comunidad)</div>
                    <div class="form-group">
                        <label class="form-label">C√≥digo AMIE</label>
                        <input type="text" class="form-input" id="originAmie">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coordenada X (UTM) *</label>
                            <input type="text" class="form-input" id="originX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordenada Y (UTM) *</label>
                            <input type="text" class="form-input" id="originY" required>
                        </div>
                    </div>
                </div>

                <div class="coord-section coord-dest">
                    <div class="coord-section-title">üè´ Destino (IE Eje) - Autocompletado</div>
                    <div class="form-group">
                        <label class="form-label">C√≥digo AMIE</label>
                        <input type="text" class="form-input" id="destAmie">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coordenada X *</label>
                            <input type="text" class="form-input" id="destX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordenada Y *</label>
                            <input type="text" class="form-input" id="destY" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Distancia (Km)</label>
                        <input type="text" class="form-input" id="routeDistance">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transporte</label>
                        <select class="form-input" id="routeTransport">
                            <option value="BUS">Bus</option>
                            <option value="FURGONETA">Furgoneta</option>
                            <option value="CANOA">Canoa/Fluvial</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary btn-block" type="submit">‚úÖ Agregar Ruta</button>
            </form>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Procesando...</div>
    </div>

    <div class="notification" id="notification"></div>

    <div class="drawing-toolbar" id="drawingToolbar">
        <span id="drawingStatus">‚úèÔ∏è Dibujando</span>
        <span class="hint">Clic para agregar puntos</span>
        <button class="btn btn-secondary btn-sm" onclick="undoLastPoint()">‚Ü© Deshacer</button>
        <button class="btn btn-primary btn-sm" onclick="finishDrawing()">‚úÖ Finalizar</button>
        <button class="btn btn-danger btn-sm" onclick="cancelDrawing()">‚úï Cancelar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- dom-to-image para mejor captura de SVG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <script>
        function convertUTM() {
    let raw = document.getElementById("inputUTM").value.trim();

    if (!raw.match(/^\d+[\s,]\d+$/)) {
        notify("Formato incorrecto. Ejemplo v√°lido: 686181, 10024104", "error");
        return;
    }

    raw = raw.replace(",", " ");
    const [x, y] = raw.split(" ").map(Number);

    const latlon = L.utm({
        x,
        y,
        zone: 17,
        southHemi: true
    }).latLon();

    document.getElementById("utmResult").innerHTML =
        `Lat: ${latlon.lat.toFixed(6)}, Lon: ${latlon.lon.toFixed(6)}`;

    map.setView([latlon.lat, latlon.lon], 16);
    L.marker([latlon.lat, latlon.lon]).addTo(map);
}
        // ==================== CONFIG ====================
        const CONFIG = {
            UTM_ZONE: 17,
            SOUTHERN_HEMISPHERE: false, // Puerto Quito est√° en hemisferio norte (Y > 10,000,000)
            DEFAULT_CENTER: [0.1, -79.2],
            DEFAULT_ZOOM: 10,
            OSRM_URL: 'https://router.project-osrm.org/route/v1/driving'
        };

        // ==================== VARIABLES ====================
        let map, routes = [], markers = [], polylines = [], ieEje = null;
        let drawingMode = false, drawingRouteId = null, drawingPolyline = null, drawingPoints = [];

        const routeColors = ['#fcd116', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'];

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initFileUpload();
            log('Sistema listo - Sube tu archivo Excel');
        });

        function initMap() {
            map = L.map('map').setView(CONFIG.DEFAULT_CENTER, CONFIG.DEFAULT_ZOOM);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | MINEDUC',
                maxZoom: 19
            }).addTo(map);
        }

        function initFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.onclick = () => fileInput.click();
            uploadArea.ondragover = (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); };
            uploadArea.ondragleave = () => uploadArea.classList.remove('dragover');
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
            };
            fileInput.onchange = (e) => { if (e.target.files[0]) processFile(e.target.files[0]); };
        }

        // ==================== DEBUG ====================
        function log(msg) {
            console.log(msg);
            const panel = document.getElementById('debugPanel');
            panel.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + panel.innerHTML;
        }

        function toggleDebug() {
            document.getElementById('debugPanel').classList.toggle('show');
        }

        // ==================== UTM ‚Üí LAT/LON ====================
        function utmToLatLon(x, y) {
            // Ecuador usa UTM Zona 17S - SIEMPRE restar 10,000,000 (false northing)
            // Esto funciona para todo Ecuador (norte y sur del ecuador)
            
            const a = 6378137.0;
            const f = 1 / 298.257223563;
            const k0 = 0.9996;
            const e = Math.sqrt(2 * f - f * f);
            const e2 = e * e;
            const ePrime2 = e2 / (1 - e2);

            const xAdj = x - 500000;
            const yAdj = y - 10000000; // SIEMPRE restar para UTM 17S de Ecuador

            const M = yAdj / k0;
            const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
            const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));

            const phi1 = mu +
                (3*e1/2 - 27*Math.pow(e1,3)/32) * Math.sin(2*mu) +
                (21*e1*e1/16 - 55*Math.pow(e1,4)/32) * Math.sin(4*mu) +
                (151*Math.pow(e1,3)/96) * Math.sin(6*mu);

            const N1 = a / Math.sqrt(1 - e2 * Math.sin(phi1) ** 2);
            const T1 = Math.tan(phi1) ** 2;
            const C1 = ePrime2 * Math.cos(phi1) ** 2;
            const R1 = a * (1 - e2) / Math.pow(1 - e2 * Math.sin(phi1) ** 2, 1.5);
            const D = xAdj / (N1 * k0);

            let lat = phi1 - (N1 * Math.tan(phi1) / R1) *
                (D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*ePrime2) * Math.pow(D,4)/24 +
                (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*ePrime2 - 3*C1*C1) * Math.pow(D,6)/720);

            const lon0 = ((CONFIG.UTM_ZONE - 1) * 6 - 180 + 3) * Math.PI / 180;
            let lon = lon0 + (D - (1 + 2*T1 + C1) * Math.pow(D,3)/6 +
                (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*ePrime2 + 24*T1*T1) * Math.pow(D,5)/120) / Math.cos(phi1);

            return { lat: lat * 180 / Math.PI, lon: lon * 180 / Math.PI };
        }

        // ==================== EXCEL PROCESSING ====================
        async function processFile(file) {
            showLoading(true, 'Leyendo Excel...');
            try {
                log('Archivo: ' + file.name);
                const data = await readExcel(file);
                parseData(data);
                showNotification('‚úÖ Archivo cargado', 'success');
            } catch (err) {
                log('ERROR: ' + err.message);
                showNotification('‚ùå ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        // Buscar hoja RUTA
                        const sheetName = wb.SheetNames.find(n => n.toUpperCase() === 'RUTA') || 
                                         wb.SheetNames.find(n => n.toUpperCase().includes('RUTA')) ||
                                         wb.SheetNames[1] || wb.SheetNames[0];
                        log('Usando hoja: ' + sheetName);
                        const sheet = wb.Sheets[sheetName];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = () => reject(new Error('Error leyendo archivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        function parseData(data) {
            // ===== EXTRAER IE EJE (formato espec√≠fico del archivo) =====
            ieEje = { nombre: '', amie: '', distrito: '', x: null, y: null };

            for (let i = 0; i < Math.min(15, data.length); i++) {
                const row = data[i];
                if (!row) continue;

                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toUpperCase().trim();
                    const nextVal = row[j + 1];

                    // AMIE IE EJE (fila 3, formato: "AMIE IE EJE:" en col 0, valor en col 1)
                    if (cell.includes('AMIE') && cell.includes('EJE') && !cell.includes('FUSIONADA')) {
                        if (nextVal) ieEje.amie = String(nextVal).trim();
                    }

                    // Nombre (fila 3)
                    if (cell.includes('NOMBRE') && cell.includes('UNIDAD') && cell.includes('EJE')) {
                        if (nextVal) ieEje.nombre = String(nextVal).trim();
                    }

                    // Distrito (fila 2)
                    if (cell.includes('NOMBRE DISTRITO')) {
                        if (nextVal) ieEje.distrito = String(nextVal).trim();
                    }

                    // Coordenada X IE Eje (fila 5, col 6="COORDENADA X", col 7=valor)
                    if (cell === 'COORDENADA X' || cell === 'COORDENADAS X') {
                        const val = parseFloat(nextVal);
                        if (!isNaN(val) && val > 100000 && val < 900000) {
                            ieEje.x = val;
                            log('IE Eje X: ' + val);
                        }
                    }

                    // Coordenada Y IE Eje (fila 6, col 6="COORDENADAS Y", col 7=valor)
                    if (cell === 'COORDENADA Y' || cell === 'COORDENADAS Y') {
                        const val = parseFloat(nextVal);
                        if (!isNaN(val) && val > 9000000 && val < 11000000) {
                            ieEje.y = val;
                            log('IE Eje Y: ' + val);
                        }
                    }
                }
            }

            // Mostrar IE Eje
            if (ieEje.amie || ieEje.x) {
                document.getElementById('ieInfoSection').style.display = 'block';
                document.getElementById('ieNombre').textContent = ieEje.nombre || '-';
                document.getElementById('ieAmie').textContent = 'AMIE: ' + (ieEje.amie || '-');
                document.getElementById('ieDistrito').textContent = ieEje.distrito || '-';

                if (ieEje.x && ieEje.y) {
                    const c = utmToLatLon(ieEje.x, ieEje.y);
                    document.getElementById('ieCoords').textContent = 
                        `UTM: ${ieEje.x.toFixed(2)}, ${ieEje.y.toFixed(2)} ‚Üí Lat: ${c.lat.toFixed(5)}, Lon: ${c.lon.toFixed(5)}`;
                    log('IE Eje LatLon: ' + c.lat.toFixed(5) + ', ' + c.lon.toFixed(5));
                }
            }

            // ===== EXTRAER RUTAS =====
            // Buscar fila de encabezado (contiene "RUTA" y "COORDENADA X")
            let headerRow = -1;
            let colRuta = 0, colAmie = 2, colBenef = 3, colDist = 7, colX = 9, colY = 10;

            for (let i = 0; i < Math.min(20, data.length); i++) {
                const row = data[i];
                if (!row) continue;
                const rowStr = row.join('|').toUpperCase();

                if (rowStr.includes('RUTA') && rowStr.includes('COORDENADA X') && rowStr.includes('BENEFICIARIOS')) {
                    headerRow = i;
                    log('Encabezado en fila ' + (i + 1));

                    // Mapear columnas
                    row.forEach((cell, idx) => {
                        const c = String(cell || '').toUpperCase().trim();
                        if (c === 'RUTA') colRuta = idx;
                        if (c.includes('AMIE') && (c.includes('FUSIONADA') || c.includes('COMUNIDAD'))) colAmie = idx;
                        if (c.includes('BENEFICIARIOS') && c.includes('RUTA')) colBenef = idx;
                        if (c.includes('DISTANCIA') && c.includes('RUTA')) colDist = idx;
                        if (c === 'COORDENADA X') colX = idx;
                        if (c === 'COORDENADA Y') colY = idx;
                    });

                    log(`Columnas: RUTA=${colRuta}, AMIE=${colAmie}, BENEF=${colBenef}, DIST=${colDist}, X=${colX}, Y=${colY}`);
                    break;
                }
            }

            if (headerRow === -1) {
                showNotification('‚ö†Ô∏è No encontr√© encabezado de rutas', 'error');
                return;
            }

            // Limpiar y procesar rutas
            clearRoutes();
            routes = [];

            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[colRuta]) continue;

                const rutaNum = parseInt(row[colRuta]);
                if (isNaN(rutaNum)) continue;

                const xOrig = parseFloat(row[colX]);
                const yOrig = parseFloat(row[colY]);

                if (isNaN(xOrig) || isNaN(yOrig)) continue;
                if (xOrig < 100000 || xOrig > 900000) continue;
                if (yOrig < 9000000 || yOrig > 11000000) continue;

                const route = {
                    id: Date.now() + Math.random(),
                    numero: rutaNum,
                    amieFusionada: String(row[colAmie] || ''),
                    amieEje: ieEje.amie,
                    beneficiarios: parseInt(row[colBenef]) || 0,
                    distancia: parseFloat(row[colDist]) || 0,
                    origen: { x: xOrig, y: yOrig },
                    destino: { x: ieEje.x, y: ieEje.y },
                    mode: 'pending',
                    manualGeometry: null
                };

                routes.push(route);
                log(`Ruta ${rutaNum}: ${route.beneficiarios} estudiantes, ${xOrig.toFixed(0)},${yOrig.toFixed(0)}`);
            }

            log(`Total: ${routes.length} rutas`);

            if (routes.length === 0) {
                showNotification('‚ö†Ô∏è No se encontraron rutas', 'error');
                return;
            }

            // Dibujar rutas
            drawAllRoutes();
        }

        // ==================== DIBUJAR RUTAS ====================
        async function drawAllRoutes() {
            showLoading(true, 'Dibujando rutas...');

            for (let i = 0; i < routes.length; i++) {
                showLoading(true, `Ruta ${i + 1} de ${routes.length}...`);
                await drawRoute(routes[i]);
                await sleep(200); // Pausa para no saturar OSRM
            }

            showLoading(false);
            updateUI();
            centerMap();
            showNotification(`‚úÖ ${routes.length} rutas dibujadas`, 'success');
        }

        async function drawRoute(route) {
            const idx = routes.indexOf(route);
            const color = routeColors[idx % routeColors.length];

            const originLL = utmToLatLon(route.origen.x, route.origen.y);

            // Marcador origen
            const originIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:26px;height:26px;border-radius:50%;
                       display:flex;align-items:center;justify-content:center;
                       font-size:11px;font-weight:bold;border:2px solid #fff;
                       box-shadow:0 2px 6px rgba(0,0,0,0.4);color:#000;">${route.numero}</div>`,
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            });

            const originMarker = L.marker([originLL.lat, originLL.lon], { icon: originIcon })
                .bindPopup(`
                    <b style="color:${color}">üìç Ruta ${route.numero} - Origen</b><br>
                    AMIE: ${route.amieFusionada || '-'}<br>
                    Estudiantes: ${route.beneficiarios}<br>
                    <small>UTM: ${route.origen.x.toFixed(0)}, ${route.origen.y.toFixed(0)}</small>
                `)
                .addTo(map);
            markers.push(originMarker);

            // Marcador destino (IE Eje) - solo una vez
            if (route.destino && route.destino.x && route.destino.y) {
                const destLL = utmToLatLon(route.destino.x, route.destino.y);

                // Verificar si ya existe marcador de destino
                const existsDest = markers.some(m => {
                    const p = m.getLatLng();
                    return Math.abs(p.lat - destLL.lat) < 0.0001 && Math.abs(p.lng - destLL.lon) < 0.0001;
                });

                if (!existsDest) {
                    const destIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:#10b981;width:34px;height:34px;border-radius:50%;
                               display:flex;align-items:center;justify-content:center;
                               font-size:18px;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.4);">üè´</div>`,
                        iconSize: [34, 34],
                        iconAnchor: [17, 17]
                    });

                    const destMarker = L.marker([destLL.lat, destLL.lon], { icon: destIcon })
                        .bindPopup(`
                            <b style="color:#10b981">üè´ IE Eje - Destino</b><br>
                            ${ieEje.nombre || '-'}<br>
                            AMIE: ${ieEje.amie || '-'}
                        `)
                        .addTo(map);
                    markers.push(destMarker);
                }

                // Calcular ruta OSRM
                try {
                    const url = `${CONFIG.OSRM_URL}/${originLL.lon},${originLL.lat};${destLL.lon},${destLL.lat}?overview=full&geometries=geojson`;
                    const resp = await fetch(url);
                    const data = await resp.json();

                    if (data.routes && data.routes[0]) {
                        const coords = data.routes[0].geometry.coordinates.map(([lon, lat]) => [lat, lon]);
                        const distKm = (data.routes[0].distance / 1000).toFixed(2);
                        const durMin = Math.round(data.routes[0].duration / 60);

                        const polyline = L.polyline(coords, {
                            color: color,
                            weight: 7,
                            opacity: 0.95
                        }).bindPopup(`
                            <b style="color:${color}">üöå Ruta ${route.numero}</b><br>
                            Distancia: ${distKm} km<br>
                            Tiempo: ~${durMin} min<br>
                            Estudiantes: ${route.beneficiarios}
                        `).addTo(map);

                        polylines.push(polyline);
                        route.distanciaCalculada = parseFloat(distKm);
                        route.mode = 'osrm';
                    } else {
                        throw new Error('Sin ruta');
                    }
                } catch (err) {
                    // Fallback: l√≠nea recta
                    const polyline = L.polyline([
                        [originLL.lat, originLL.lon],
                        [destLL.lat, destLL.lon]
                    ], {
                        color: color,
                        weight: 5,
                        opacity: 0.7,
                        dashArray: '10, 6'
                    }).bindPopup(`
                        <b style="color:${color}">üöå Ruta ${route.numero}</b> (l√≠nea recta)<br>
                        <i>Usa ‚úèÔ∏è para dibujar el camino real</i>
                    `).addTo(map);

                    polylines.push(polyline);
                    route.mode = 'straight';
                }
            }
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // ==================== DIBUJO MANUAL ====================
        function startDrawing(routeId) {
            const route = routes.find(r => r.id == routeId);
            if (!route) return;

            cancelDrawing();
            drawingMode = true;
            drawingRouteId = routeId;
            drawingPoints = [];

            const idx = routes.indexOf(route);
            const color = routeColors[idx % routeColors.length];

            document.getElementById('drawingStatus').textContent = `‚úèÔ∏è Ruta ${route.numero}`;
            document.getElementById('drawingToolbar').style.display = 'flex';

            map.on('click', onMapClick);

            const ll = utmToLatLon(route.origen.x, route.origen.y);
            map.setView([ll.lat, ll.lon], 15);

            showNotification('Haz clic en el mapa para dibujar la ruta', 'info');
        }

        async function onMapClick(e) {
            if (!drawingMode) return;

            drawingPoints.push(e.latlng);

            const route = routes.find(r => r.id == drawingRouteId);
            const idx = routes.indexOf(route);
            const color = routeColors[idx % routeColors.length];

            if (drawingPoints.length === 1) {
                drawingPolyline = L.polyline([e.latlng], { color, weight: 7, opacity: 0.95 }).addTo(map);
                polylines.push(drawingPolyline);
            } else {
                const last = drawingPoints[drawingPoints.length - 2];
                const curr = e.latlng;

                // Intentar snap con OSRM
                try {
                    const url = `${CONFIG.OSRM_URL}/${last.lng},${last.lat};${curr.lng},${curr.lat}?overview=full&geometries=geojson`;
                    const resp = await fetch(url);
                    const data = await resp.json();

                    if (data.routes && data.routes[0]) {
                        const newCoords = data.routes[0].geometry.coordinates.map(([lon, lat]) => L.latLng(lat, lon));
                        const existing = drawingPolyline.getLatLngs();
                        drawingPolyline.setLatLngs(existing.concat(newCoords.slice(1)));
                    } else {
                        drawingPolyline.addLatLng(curr);
                    }
                } catch {
                    drawingPolyline.addLatLng(curr);
                }
            }

            // Marcador de punto
            L.circleMarker(e.latlng, { radius: 5, color, fillColor: '#fff', fillOpacity: 1, weight: 2 }).addTo(map);
        }

        function undoLastPoint() {
            if (drawingPoints.length > 1) {
                drawingPoints.pop();
                // Simplificar: redibujar
                const route = routes.find(r => r.id == drawingRouteId);
                const idx = routes.indexOf(route);
                const color = routeColors[idx % routeColors.length];
                drawingPolyline.setLatLngs(drawingPoints);
            }
        }

        function finishDrawing() {
            if (!drawingMode || drawingPoints.length < 2) {
                showNotification('Dibuja al menos 2 puntos', 'error');
                return;
            }

            const route = routes.find(r => r.id == drawingRouteId);
            if (!route) return;

            const latlngs = drawingPolyline.getLatLngs();
            route.manualGeometry = latlngs.map(ll => ({ lat: ll.lat, lon: ll.lng }));
            route.mode = 'manual';

            // Calcular distancia
            let dist = 0;
            for (let i = 1; i < latlngs.length; i++) {
                dist += haversine(latlngs[i-1], latlngs[i]);
            }
            route.distanciaCalculada = dist;

            const idx = routes.indexOf(route);
            const color = routeColors[idx % routeColors.length];

            drawingPolyline.bindPopup(`
                <b style="color:${color}">üöå Ruta ${route.numero}</b> (manual)<br>
                Distancia: ${dist.toFixed(2)} km<br>
                Estudiantes: ${route.beneficiarios}
            `);

            showNotification(`‚úÖ Ruta ${route.numero}: ${dist.toFixed(2)} km`, 'success');
            cancelDrawing();
            updateUI();
        }

        function cancelDrawing() {
            drawingMode = false;
            drawingRouteId = null;
            drawingPoints = [];
            drawingPolyline = null;
            map.off('click', onMapClick);
            document.getElementById('drawingToolbar').style.display = 'none';
        }

        function haversine(a, b) {
            const R = 6371;
            const dLat = (b.lat - a.lat) * Math.PI / 180;
            const dLon = (b.lng - a.lng) * Math.PI / 180;
            const h = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180) * Math.cos(b.lat*Math.PI/180) * Math.sin(dLon/2)**2;
            return 2 * R * Math.asin(Math.sqrt(h));
        }

        // ==================== UI ====================
        function updateUI() {
            const list = document.getElementById('routeList');

            if (routes.length === 0) {
                list.innerHTML = `<div style="text-align:center;padding:25px;color:var(--text-muted);">
                    <div style="font-size:2rem;margin-bottom:8px;">üõ£Ô∏è</div>No hay rutas</div>`;
            } else {
                list.innerHTML = routes.map((r, i) => {
                    const color = routeColors[i % routeColors.length];
                    const modeLabel = r.mode === 'manual' ? '‚úèÔ∏è Manual' : r.mode === 'osrm' ? 'üõ£Ô∏è OSRM' : 'üìè L√≠nea';
                    const modeStyle = r.mode === 'manual' ? '' : r.mode === 'osrm' ? 'border-color:#3b82f6;color:#93c5fd;' : 'border-color:#f59e0b;color:#fcd34d;';

                    return `<div class="route-item">
                        <div class="route-header">
                            <span class="route-number" style="color:${color}">üöå Ruta ${r.numero}</span>
                            <span class="route-mode-tag" style="${modeStyle}">${modeLabel}</span>
                        </div>
                        <div class="route-info">
                            <span>üìç ${r.amieFusionada || '-'}</span>
                            <span>üë• ${r.beneficiarios} estudiantes</span>
                            <span>üìè ${(r.distanciaCalculada || r.distancia || 0).toFixed(2)} km</span>
                        </div>
                        <div class="route-actions" style="margin-top:6px;">
                            <button class="btn btn-secondary btn-sm" onclick="startDrawing('${r.id}')">‚úèÔ∏è Dibujar</button>
                            <button class="btn btn-sm" style="background:#3b82f6;color:#fff;" onclick="zoomTo('${r.id}')">üîç</button>
                            <button class="route-delete" onclick="deleteRoute('${r.id}')">‚úï</button>
                        </div>
                    </div>`;
                }).join('');
            }

            document.getElementById('routeCount').textContent = routes.length;
            document.getElementById('totalRoutes').textContent = routes.length;
            document.getElementById('totalStudents').textContent = routes.reduce((s, r) => s + r.beneficiarios, 0);
            document.getElementById('totalDistance').textContent = routes.reduce((s, r) => s + (r.distanciaCalculada || r.distancia || 0), 0).toFixed(1);
            document.getElementById('totalIE').textContent = new Set(routes.map(r => r.amieFusionada).filter(a => a)).size;
        }

        function zoomTo(id) {
            const r = routes.find(x => x.id == id);
            if (r) {
                const ll = utmToLatLon(r.origen.x, r.origen.y);
                map.setView([ll.lat, ll.lon], 15);
            }
        }

        function deleteRoute(id) {
            routes = routes.filter(r => r.id != id);
            redrawAll();
            updateUI();
        }

        function clearRoutes() {
            markers.forEach(m => map.removeLayer(m));
            polylines.forEach(p => map.hasLayer(p) && map.removeLayer(p));
            markers = [];
            polylines = [];
        }

        function redrawAll() {
            clearRoutes();
            routes.forEach(r => {
                if (r.mode === 'manual' && r.manualGeometry) {
                    const idx = routes.indexOf(r);
                    const color = routeColors[idx % routeColors.length];
                    const latlngs = r.manualGeometry.map(p => L.latLng(p.lat, p.lon));
                    const poly = L.polyline(latlngs, { color, weight: 7, opacity: 0.95 }).addTo(map);
                    polylines.push(poly);
                } else {
                    drawRoute(r);
                }
            });
        }

        function clearAll() {
            if (!confirm('¬øEliminar todo?')) return;
            routes = [];
            ieEje = null;
            clearRoutes();
            updateUI();
            document.getElementById('ieInfoSection').style.display = 'none';
        }

        function centerMap() {
            if (markers.length > 0) {
                map.fitBounds(L.featureGroup(markers).getBounds().pad(0.15));
            }
        }

        // ==================== MODAL ====================
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
            if (ieEje) {
                document.getElementById('destAmie').value = ieEje.amie || '';
                document.getElementById('destX').value = ieEje.x || '';
                document.getElementById('destY').value = ieEje.y || '';
            }
            document.getElementById('routeNumber').value = routes.length > 0 ? Math.max(...routes.map(r => parseInt(r.numero) || 0)) + 1 : 1;
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        async function addManualRoute(e) {
            e.preventDefault();

            const route = {
                id: Date.now(),
                numero: document.getElementById('routeNumber').value,
                amieFusionada: document.getElementById('originAmie').value,
                amieEje: document.getElementById('destAmie').value,
                beneficiarios: parseInt(document.getElementById('routeBeneficiaries').value) || 0,
                distancia: parseFloat(document.getElementById('routeDistance').value) || 0,
                origen: { x: parseFloat(document.getElementById('originX').value), y: parseFloat(document.getElementById('originY').value) },
                destino: { x: parseFloat(document.getElementById('destX').value), y: parseFloat(document.getElementById('destY').value) },
                mode: 'pending',
                manualGeometry: null
            };

            if (isNaN(route.origen.x) || isNaN(route.origen.y)) {
                showNotification('‚ùå Coordenadas inv√°lidas', 'error');
                return;
            }

            routes.push(route);
            showLoading(true, 'Calculando...');
            await drawRoute(route);
            showLoading(false);
            updateUI();
            closeModal();
            centerMap();
            document.getElementById('routeForm').reset();
        }

        // ==================== EXPORT ====================
        async function captureMap() {
            // Usar dom-to-image que captura mejor los SVG de Leaflet
            const mapEl = document.getElementById('map');
            
            // Esperar un momento para que todo se renderice
            await new Promise(r => setTimeout(r, 500));
            
            try {
                // Intentar con dom-to-image primero (mejor para SVG)
                const dataUrl = await domtoimage.toJpeg(mapEl, {
                    quality: 0.95,
                    bgcolor: '#ffffff',
                    style: {
                        'transform': 'none'
                    }
                });
                return dataUrl;
            } catch (err) {
                console.log('dom-to-image fall√≥, usando html2canvas:', err);
                // Fallback a html2canvas
                const canvas = await html2canvas(mapEl, { 
                    useCORS: true, 
                    scale: 2,
                    logging: false,
                    allowTaint: true
                });
                return canvas.toDataURL('image/jpeg', 0.95);
            }
        }

        async function exportToJPG() {
            showLoading(true, 'Capturando mapa...');
            try {
                const dataUrl = await captureMap();
                const link = document.createElement('a');
                link.download = `rutas_${ieEje?.amie || 'mapa'}_${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = dataUrl;
                link.click();
                showNotification('üì∑ JPG exportado', 'success');
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportToPDF() {
            showLoading(true, 'Generando PDF...');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');

                // Bandera
                doc.setFillColor(252, 209, 22); doc.rect(0, 0, 297, 8, 'F');
                doc.setFillColor(0, 56, 147); doc.rect(0, 8, 297, 3, 'F');
                doc.setFillColor(206, 17, 38); doc.rect(0, 11, 297, 2, 'F');

                // T√≠tulo
                doc.setFontSize(16);
                doc.setTextColor(0, 56, 147);
                doc.text('INFORME DE RUTAS DE TRANSPORTE ESCOLAR', 148.5, 22, { align: 'center' });

                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text('Ministerio de Educaci√≥n - Ecuador', 148.5, 28, { align: 'center' });

                let y = 38;

                if (ieEje?.amie) {
                    doc.setFontSize(11);
                    doc.setTextColor(0);
                    doc.setFont(undefined, 'bold');
                    doc.text('IE Eje:', 20, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${ieEje.nombre || '-'} (AMIE: ${ieEje.amie})`, 45, y);
                    y += 6;
                    doc.text(`Distrito: ${ieEje.distrito || '-'}`, 20, y);
                }

                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Resumen:', 20, y);
                doc.setFont(undefined, 'normal');
                y += 6;
                doc.text(`Rutas: ${routes.length} | Estudiantes: ${routes.reduce((s,r) => s + r.beneficiarios, 0)} | Distancia total: ${routes.reduce((s,r) => s + (r.distanciaCalculada || r.distancia || 0), 0).toFixed(2)} km`, 20, y);

                // Mapa - usar captura mejorada
                y += 8;
                showLoading(true, 'Capturando mapa para PDF...');
                const mapDataUrl = await captureMap();
                doc.addImage(mapDataUrl, 'JPEG', 15, y, 200, 110);

                y += 115;

                // Funci√≥n para dibujar encabezado de tabla
                function drawTableHeader(yPos) {
                    doc.setFillColor(0, 56, 147);
                    doc.setTextColor(255);
                    doc.rect(20, yPos - 4, 257, 7, 'F');
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text('Ruta', 25, yPos);
                    doc.text('AMIE Origen', 45, yPos);
                    doc.text('Estudiantes', 105, yPos);
                    doc.text('Dist. Excel', 135, yPos);
                    doc.text('Dist. Calc.', 165, yPos);
                    doc.text('Modo', 200, yPos);
                    doc.text('Transporte', 230, yPos);
                    return yPos + 6;
                }

                // Tabla - mostrar TODAS las rutas
                doc.setFont(undefined, 'bold');
                doc.text('Detalle de Rutas:', 20, y);
                y += 6;

                y = drawTableHeader(y);
                doc.setTextColor(0);
                doc.setFont(undefined, 'normal');

                const pageHeight = 200; // Altura m√°xima antes de nueva p√°gina

                routes.forEach((r, i) => {
                    // Si llegamos al final de la p√°gina, crear nueva p√°gina
                    if (y > pageHeight) {
                        doc.addPage();
                        y = 20;
                        
                        // Bandera en nueva p√°gina
                        doc.setFillColor(252, 209, 22); doc.rect(0, 0, 297, 5, 'F');
                        doc.setFillColor(0, 56, 147); doc.rect(0, 5, 297, 2, 'F');
                        doc.setFillColor(206, 17, 38); doc.rect(0, 7, 297, 1, 'F');
                        
                        y = 15;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 56, 147);
                        doc.text('Detalle de Rutas (continuaci√≥n)', 20, y);
                        y += 8;
                        
                        y = drawTableHeader(y);
                        doc.setTextColor(0);
                        doc.setFont(undefined, 'normal');
                    }

                    // Fondo alternado
                    if (i % 2 === 0) { 
                        doc.setFillColor(245, 245, 245); 
                        doc.rect(20, y - 3, 257, 6, 'F'); 
                    }

                    doc.setFontSize(8);
                    doc.text(String(r.numero), 25, y);
                    doc.text(String(r.amieFusionada || '-').substring(0, 20), 45, y);
                    doc.text(String(r.beneficiarios), 110, y);
                    doc.text((r.distancia || 0).toFixed(2), 138, y);
                    doc.text((r.distanciaCalculada || 0).toFixed(2), 168, y);
                    doc.text(r.mode === 'manual' ? 'Manual' : r.mode === 'osrm' ? 'OSRM' : 'L√≠nea', 200, y);
                    doc.text(r.transporte || 'Bus', 230, y);
                    y += 6;
                });

                // Pie de p√°gina con n√∫meros de p√°gina
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Generado: ${new Date().toLocaleString('es-EC')} | P√°gina ${i} de ${pageCount}`,
                        148.5, 205, { align: 'center' }
                    );
                }

                doc.save(`informe_rutas_${ieEje?.amie || 'export'}_${new Date().toISOString().slice(0,10)}.pdf`);
                showNotification('üìÑ PDF generado', 'success');
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== UTILS ====================
        function showLoading(show, text = 'Procesando...') {
            document.getElementById('loading').classList.toggle('show', show);
            document.getElementById('loadingText').textContent = text;
        }

        function showNotification(msg, type = 'info') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove('show'), 4000);
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeModal(); cancelDrawing(); }
        });
    </script>
</body>
</html>
