<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Sistema de Rutas Escolares MINEDUC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- SheetJS para leer Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Leaflet-image para exportar JPG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-image/0.0.4/leaflet-image.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
    }
    #map {
        width: 100%;
        height: 88vh;
    }
    #topBar {
        padding: 10px;
        background: #f3f4f6;
        border-bottom: 1px solid #ddd;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    button {
        padding: 8px 14px;
        background: #2563eb;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
    }
    button:hover {
        background: #1e40af;
    }
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #000000cc;
        color: white;
        padding: 12px 18px;
        border-radius: 6px;
        z-index: 3000;
    }
</style>

</head>
<body>

<div id="topBar">
    <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm" />
    <button onclick="exportMap()">Exportar mapa (JPG)</button>
</div>

<div id="map"></div>

<script>
/* ============================================================
   MAPA INICIAL
============================================================ */
let map = L.map("map").setView([-0.3, -78.5], 9);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

/* Marcadores */
let originIcon = L.divIcon({
    html: `<div style="background:#10b981;width:26px;height:26px;border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;">O</div>`,
    iconSize:[26,26], iconAnchor:[13,13]
});

let destIcon = L.divIcon({
    html: `<div style="background:#3b82f6;width:30px;height:30px;border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;">D</div>`,
    iconSize:[30,30], iconAnchor:[15,15]
});

let routes = [];
let drawnLayers = [];

/* ============================================================
   NOTIFICACIONES
============================================================ */
function notify(msg, type="info") {
    let div = document.createElement("div");
    div.className = "notification";
    
    div.style.background = type === "error" ? "#dc2626" :
                           type === "success" ? "#16a34a" : "#334155";

    div.textContent = msg;
    document.body.appendChild(div);

    setTimeout(() => div.remove(), 3000);
}

/* ============================================================
   UTM ‚Üí LAT/LON (EPSG:32717 Ecuador)
============================================================ */
function utmToLatLon(x, y) {
    const zone = 17;
    const south = true;
    const a = 6378137.0;
    const e = 0.081819191;
    const k0 = 0.9996;

    x = x - 500000.0;
    if (south) y -= 10000000.0;

    const M = y / k0;
    const mu = M / (a * (1 - e**2 / 4 - 3*e**4/64 - 5*e**6/256));

    const e1 = (1 - Math.sqrt(1 - e**2)) / (1 + Math.sqrt(1 - e**2));
    const J1 = 3*e1/2 - 27*e1**3/32;
    const J2 = 21*e1**2/16 - 55*e1**4/32;
    const J3 = 151*e1**3/96;
    const J4 = 1097*e1**4/512;

    const fp = mu + J1*Math.sin(2*mu) + J2*Math.sin(4*mu) + J3*Math.sin(6*mu) + J4*Math.sin(8*mu);

    const C1 = (e**2 / (1 - e**2)) * Math.cos(fp)**2;
    const T1 = Math.tan(fp)**2;
    const R1 = a*(1 - e**2) / Math.pow(1 - e**2 * Math.sin(fp)**2, 1.5);
    const N1 = a / Math.sqrt(1 - e**2 * Math.sin(fp)**2);

    const D = x / (N1 * k0);

    let lat = fp - (N1*Math.tan(fp)/R1) *
        (D**2/2 - (5 + 3*T1 + 10*C1 - 4*C1**2 - 9*(e**2/(1-e**2))) * D**4 / 24);
    let lon = (D - (1 + 2*T1 + C1) * D**3/6) / Math.cos(fp);

    lat = lat * (180/Math.PI);
    lon = lon * (180/Math.PI) + (zone*6 - 183);

    return {lat, lon};
}
/* ===================================================================
   VALIDACI√ìN AVANZADA DEL EXCEL
=================================================================== */

function validateCoordinate(x, y) {
    if (!x || !y) return false;
    if (isNaN(x) || isNaN(y)) return false;
    if (x < 600000 || x > 900000) return false;   // Rango UTM Ecuador
    if (y < 9900000 || y > 10050000) return false;
    return true;
}

function validateIEEje() {
    let errors = [];

    if (!ieEje.amie) {
        errors.push("No se encontr√≥ AMIE IE EJE en el encabezado.");
    }

    if (!validateCoordinate(ieEje.x, ieEje.y)) {
        errors.push("Coordenadas X/Y del IE EJE no v√°lidas.");
    }

    if (errors.length > 0) {
        notify("Error IE EJE:\n" + errors.join("\n"), "error");
        return false;
    }
    return true;
}

/* ===================================================================
   LEER "IE EJE" (ENCABEZADO DEL EXCEL)
=================================================================== */

let ieEje = { amie: "", nombre: "", distrito: "", x: null, y: null };

function extractIEEje(sheet) {
    ieEje = { amie: "", nombre: "", distrito: "", x: null, y: null };

    for (let i = 0; i < 20; i++) {
        const row = sheet[i];
        if (!row) continue;

        for (let j = 0; j < row.length; j++) {
            const cell = String(row[j] || "").toUpperCase().trim();

            // AMIE IE EJE
            if (cell.includes("AMIE IE EJE")) {
                ieEje.amie = sheet[i][j + 1];
            }

            // Nombre IE
            if (cell.includes("NOMBRE UNIDAD EDUCATIVA EJE")) {
                ieEje.nombre = sheet[i][j + 1];
            }

            // Distrito
            if (cell.includes("NOMBRE DISTRITO")) {
                ieEje.distrito = sheet[i][j + 1];
            }

            // Coordenada X
            if (cell === "COORDENADA X" || cell === "COORDENADAS X") {
                const val = parseFloat(sheet[i][j + 1]);
                if (!isNaN(val)) ieEje.x = val;
            }

            // Coordenada Y
            if (cell === "COORDENADA Y" || cell === "COORDENADAS Y") {
                const val = parseFloat(sheet[i][j + 1]);
                if (!isNaN(val)) ieEje.y = val;
            }
        }
    }

    if (!validateIEEje()) {
        notify("El Excel tiene errores en el IE EJE.", "error");
        return false;
    }

    notify("IE EJE cargado correctamente: " + ieEje.amie, "success");
    return true;
}

/* ===================================================================
   EXTRAER RUTAS - HOJA RUTA (MULTI-RUTA)
=================================================================== */

function extractRoutes(sheet) {
    routes = [];

    // Buscar encabezado RUTA
    let headerRow = -1;
    let col = {};

    for (let i = 0; i < 50; i++) {
        const row = sheet[i];
        if (!row) continue;

        const rowStr = row.join(" ").toUpperCase();

        if (rowStr.includes("RUTA") && rowStr.includes("COORDENADA")) {
            headerRow = i;

            row.forEach((cell, idx) => {
                const c = String(cell || "").toUpperCase().trim();

                if (c === "RUTA") col.ruta = idx;
                if (c.includes("AMIE") && c.includes("EJE")) col.amieEje = idx;
                if (c.includes("AMIE") && (c.includes("FUSIONADA") || c.includes("COMUNIDAD")))
                    col.amieFusionada = idx;

                if (c === "COORDENADA X") col.x = idx;
                if (c === "COORDENADA Y") col.y = idx;

                if (c.includes("BENEFICIARIOS")) col.benef = idx;
                if (c.includes("DISTANCIA") && c.includes("RUTA")) col.dist = idx;
            });
            break;
        }
    }

    if (headerRow === -1) {
        notify("No se encontr√≥ encabezado de rutas.", "error");
        return;
    }

    // Leer filas de rutas
    for (let i = headerRow + 1; i < sheet.length; i++) {
        const row = sheet[i];
        if (!row || !row[col.ruta]) continue;

        let numRuta = row[col.ruta];
        if (isNaN(numRuta)) continue;

        let xO = parseFloat(row[col.x]);
        let yO = parseFloat(row[col.y]);

        if (!validateCoordinate(xO, yO)) {
            notify(`Ruta ${numRuta}: Coordenadas origen inv√°lidas`, "error");
            continue;
        }

        if (!validateCoordinate(ieEje.x, ieEje.y)) {
            notify(`Ruta ${numRuta}: Coordenadas de destino IE EJE inv√°lidas`, "error");
            continue;
        }

        const route = {
            id: Date.now() + Math.random(),
            numero: numRuta,
            amieFusionada: row[col.amieFusionada],
            amieEje: ieEje.amie,
            origen: { x: xO, y: yO },
            destino: { x: ieEje.x, y: ieEje.y }
        };

        routes.push(route);
        drawRoute(route);
    }

    notify(`${routes.length} rutas cargadas correctamente.`, "success");
}
/* ================================================================
   PARTE 3 ‚Äî DIBUJAR RUTAS / OSRM / CLICK COMO GOOGLE MAPS
=================================================================== */

let drawMode = false;
let clickOrigin = null;
let clickDest = null;

/* ==========================
   ACTIVAR MODO GOOGLE MAPS
========================== */

function activateDrawMode() {
    drawMode = true;
    clickOrigin = null;
    clickDest = null;

    notify("Haz clic en el mapa para seleccionar ORIGEN", "info");
}

map.on("click", function (e) {
    if (!drawMode) return;

    if (!clickOrigin) {
        clickOrigin = e.latlng;
        L.marker(clickOrigin, {
            icon: L.divIcon({
                html: `<div style="background:#10b981;width:26px;height:26px;border-radius:50%;border:3px solid white"></div>`,
                className: "",
                iconSize: [26, 26],
                iconAnchor: [13, 13],
            }),
        }).addTo(map);

        notify("Ahora haz clic para seleccionar DESTINO", "info");
        return;
    }

    clickDest = e.latlng;

    L.marker(clickDest, {
        icon: L.divIcon({
            html: `<div style="background:#2563eb;width:26px;height:26px;border-radius:50%;border:3px solid white"></div>`,
            className: "",
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        }),
    }).addTo(map);

    // Llamar a OSRM
    drawManualClickRoute(clickOrigin, clickDest);

    drawMode = false;
    notify("Ruta generada por clic", "success");
});

/* ================================================================
   CONVERTIR UTM ‚Üí LAT/LON
=================================================================== */

function utmPointToLatLon(pt) {
    return utmToLatLon(pt.x, pt.y, 17, true);
}

/* ================================================================
   FUNCI√ìN PRINCIPAL PARA DIBUJAR RUTA DESDE EL EXCEL
=================================================================== */

async function drawRoute(route) {
    const origin = utmPointToLatLon(route.origen);
    const dest = utmPointToLatLon(route.destino);

    return drawWithOSRM(origin, dest, route);
}

/* ================================================================
   BACKEND OSRM + FALLBACK
=================================================================== */

const OSRM_URL = "https://rutas-escolares.vercel.app/api/route";

async function drawWithOSRM(origin, dest, routeObj = null) {
    showLoading(true);

    try {
        const body = {
            origin: { lat: origin.lat, lon: origin.lon },
            dest: { lat: dest.lat, lon: dest.lon },
        };

        const resp = await fetch(OSRM_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
        });

        const data = await resp.json();

        if (!resp.ok || !data.coords) throw new Error("OSRM error");

        const coords = data.coords.map((c) => [c.lat, c.lon]);

        const poly = L.polyline(coords, {
            color: "#f59e0b",
            weight: 5,
            opacity: 0.9,
        }).addTo(map);

        polylines.push(poly);

        if (routeObj) routeObj.distancia = data.distance_km;

        notify(
            `Ruta calculada: ${data.distance_km.toFixed(2)} km (${data.duration_min} min)`,
            "success"
        );

        return true;
    } catch (err) {
        console.warn("OSRM ca√≠da, usando fallback‚Ä¶", err);
        fallbackLine(origin, dest);
        notify("OSRM no disponible, usando l√≠nea directa.", "error");
        return false;
    } finally {
        showLoading(false);
    }
}

/* ================================================================
   FALLBACK ‚Äî L√çNEA DIRECTA SUAVIZADA (cuando OSRM falla)
=================================================================== */

function fallbackLine(origin, dest) {
    const poly = L.polyline(
        [
            [origin.lat, origin.lon],
            [dest.lat, dest.lon],
        ],
        {
            color: "#ef4444",
            weight: 3,
            opacity: 0.7,
            dashArray: "8, 6",
        }
    ).addTo(map);

    polylines.push(poly);
}

/* ================================================================
   GENERAR RUTA POR CLIC (GOOGLE MAPS MODE)
=================================================================== */

async function drawManualClickRoute(origin, dest) {
    await drawWithOSRM(origin, dest);
}

/* ================================================================
   NOTIFICACIONES
=================================================================== */

function notify(msg, type = "info") {
    const n = document.getElementById("notification");
    n.innerHTML = msg;
    n.className = `notification ${type} show`;

    setTimeout(() => {
        n.classList.remove("show");
    }, 3000);
}
<!-- ===============================
     NUEVA SECCI√ìN ‚Äî HERRAMIENTAS
================================== -->
<div class="section">
    <div class="section-title">üõ†Ô∏è Herramientas de Ruta</div>

    <button class="btn btn-primary btn-block" onclick="activateDrawMode()">
        ‚úèÔ∏è Dibujar ruta por clic (modo Google Maps)
    </button>

    <button class="btn btn-secondary btn-block" onclick="validateExcelRoutes()">
        ‚úîÔ∏è Validar Excel antes de dibujar
    </button>

    <button class="btn btn-success btn-block" onclick="centerMap()">
        üéØ Centrar mapa
    </button>
</div>
/* ============================================================
   VALIDAR EXCEL ANTES DE GENERAR RUTAS
   - Detecta coordenadas err√≥neas
   - Detecta rutas incompletas
   - Detecta IE eje sin coordenadas
=============================================================== */

function validateExcelRoutes() {

    if (!ieEje) {
        notify("No se pudo leer la IE Eje del archivo.", "error");
        return false;
    }

    if (!ieEje.x || !ieEje.y || ieEje.x < 100000 || ieEje.y < 100000) {
        notify("Coordenadas de IE Eje inv√°lidas o incompletas.", "error");
        return false;
    }

    if (routes.length === 0) {
        notify("El archivo Excel no contiene rutas v√°lidas.", "error");
        return false;
    }

    let errores = [];

    routes.forEach((r, i) => {
        if (!r.origen.x || !r.origen.y) {
            errores.push(`Ruta ${r.numero}: origen sin coordenadas`);
        }

        if (r.origen.x < 100000 || r.origen.y < 100000) {
            errores.push(`Ruta ${r.numero}: coordenadas UTM inv√°lidas`);
        }
    });

    if (errores.length > 0) {
        notify("Archivo contiene errores en coordenadas. Rev√≠salo.", "error");
        console.warn("ERRORES DETECTADOS:", errores);
        return false;
    }

    notify("Validaci√≥n correcta. Puedes dibujar rutas.", "success");
    return true;
}
