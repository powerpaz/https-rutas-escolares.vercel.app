<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå Sistema de Rutas de Transporte Escolar - MINEDEC Ecuador</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --yellow: #fcd116;
            --blue: #003893;
            --red: #ce1126;
            --dark-bg: #0a1628;
            --card-bg: rgba(15, 30, 55, 0.95);
            --text-light: #e8f0ff;
            --text-muted: #8ba3c7;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a365d 50%, var(--dark-bg) 100%);
            min-height: 100vh;
            color: var(--text-light);
        }

        .header {
            background: linear-gradient(90deg, var(--yellow) 0%, var(--yellow) 33%, var(--blue) 33%, var(--blue) 66%, var(--red) 66%, var(--red) 100%);
            height: 6px;
        }

        .header-content {
            background: var(--card-bg);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(252, 209, 22, 0.2);
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--yellow);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-section h1 .logo-img {
            height: 60px;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .logo-section span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 90px);
        }

        .sidebar {
            background: var(--card-bg);
            border-right: 1px solid rgba(252, 209, 22, 0.2);
            overflow-y: auto;
            padding: 15px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--yellow);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed rgba(252, 209, 22, 0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(252, 209, 22, 0.05);
        }

        .upload-area:hover {
            border-color: var(--yellow);
            background: rgba(252, 209, 22, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-area input[type="file"] { display: none; }
        .upload-icon { font-size: 2rem; margin-bottom: 8px; }
        .upload-text { font-size: 0.8rem; color: var(--text-muted); }
        .upload-text strong { color: var(--yellow); }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.8rem;
        }

        .btn-primary { background: var(--yellow); color: var(--dark-bg); }
        .btn-primary:hover { background: #e5bc00; }
        .btn-secondary { background: transparent; color: var(--yellow); border: 1px solid var(--yellow); }
        .btn-secondary:hover { background: rgba(252, 209, 22, 0.1); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--red); color: white; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }

        #map { width: 100%; height: 100%; }

        .ie-info {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 12px;
        }

        .ie-info h3 { color: var(--success); font-size: 0.85rem; margin-bottom: 8px; }
        .ie-info p { font-size: 0.75rem; color: var(--text-muted); margin: 4px 0; }
        .ie-info .coords { font-family: monospace; font-size: 0.7rem; color: var(--yellow); }

        .route-list { max-height: 280px; overflow-y: auto; }

        .route-item {
            background: rgba(252, 209, 22, 0.05);
            border: 1px solid rgba(252, 209, 22, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .route-item:hover {
            border-color: var(--yellow);
            background: rgba(252, 209, 22, 0.1);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .route-number { font-weight: 600; font-size: 0.9rem; }

        .route-mode-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.6);
            color: #a7f3d0;
        }

        .route-actions { display: flex; gap: 4px; }

        .route-delete {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
        }

        .route-info { font-size: 0.7rem; color: var(--text-muted); }
        .route-info span { display: block; margin-bottom: 2px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: rgba(252, 209, 22, 0.08);
            border: 1px solid rgba(252, 209, 22, 0.2);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .stat-value { font-size: 1.3rem; font-weight: 700; color: var(--yellow); }
        .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(252, 209, 22, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title { font-size: 1.1rem; font-weight: 600; color: var(--yellow); }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(252, 209, 22, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            font-size: 0.85rem;
        }

        .form-input:focus { outline: none; border-color: var(--yellow); }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .coord-section {
            background: rgba(252, 209, 22, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid var(--yellow);
        }

        .coord-section.coord-dest {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .coord-section-title { font-size: 0.8rem; font-weight: 600; margin-bottom: 10px; }

        .loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading.show { opacity: 1; visibility: visible; }

        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(252, 209, 22, 0.2);
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { margin-top: 15px; color: var(--text-light); }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-size: 0.85rem;
            z-index: 3001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

        .drawing-toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3500;
            background: rgba(15, 30, 55, 0.98);
            border-radius: 12px;
            border: 2px solid var(--yellow);
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.6);
        }

        .drawing-toolbar span { color: var(--yellow); font-weight: 600; }
        .drawing-toolbar .hint { color: var(--text-muted); font-size: 0.7rem; font-weight: normal; }

        .debug-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--yellow);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.65rem;
            color: #0f0;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-panel.show { display: block; }

        /* ==================== LAT LON TOOLS STYLES ==================== */
        .latlon-tools-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .latlon-tools-panel .section-title {
            color: #60a5fa;
            margin-bottom: 12px;
        }

        .latlon-tools-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .latlon-tab {
            flex: 1;
            padding: 6px 8px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .latlon-tab:hover {
            background: rgba(59, 130, 246, 0.2);
            color: var(--text-light);
        }

        .latlon-tab.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .latlon-content {
            display: none;
        }

        .latlon-content.active {
            display: block;
        }

        .coord-display {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .coord-display-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .coord-display-row:last-child {
            border-bottom: none;
        }

        .coord-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .coord-value {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #60a5fa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .coord-value:hover {
            color: var(--yellow);
        }

        .converter-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .converter-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .converter-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.7rem;
        }

        .result-label {
            color: var(--text-muted);
        }

        .result-value {
            font-family: 'Courier New', monospace;
            color: #60a5fa;
            cursor: pointer;
        }

        .result-value:hover {
            color: var(--yellow);
        }

        .latlon-btn-group {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .latlon-btn {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
        }

        .latlon-btn-primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .latlon-btn-primary:hover {
            background: rgba(59, 130, 246, 0.4);
        }

        .latlon-btn-success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #34d399;
        }

        .latlon-btn-success:hover {
            background: rgba(16, 185, 129, 0.4);
        }

        .cursor-coords-bar {
            position: fixed;
            bottom: 10px;
            left: 400px;
            background: rgba(15, 30, 55, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            gap: 20px;
            font-size: 0.7rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .cursor-coord-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cursor-coord-label {
            color: var(--text-muted);
        }

        .cursor-coord-value {
            font-family: 'Courier New', monospace;
            color: #60a5fa;
            min-width: 100px;
        }

        .capture-mode-active {
            border-color: var(--yellow) !important;
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(252, 209, 22, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(252, 209, 22, 0.2); }
        }

        .zoom-marker {
            background: rgba(252, 209, 22, 0.9);
            border: 3px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .format-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .capture-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(252, 209, 22, 0.9);
            color: #000;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .capture-indicator.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { max-height: 45vh; }
            .cursor-coords-bar { left: 10px; right: 10px; bottom: 60px; }
        }
    </style>
</head>
<body>
    <div class="header"></div>

    <div class="header-content">
        <div class="logo-section">
            <h1>
                üöå Sistema de calculo de Rutas de Transporte Escolar - MINEDEC
                <img src="logo.png" alt="Ecuador" class="logo-img">
            </h1>
            <span>DPI-CGPGE</span>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-secondary" onclick="centerMap()">üìç Centrar</button>
            <button class="btn btn-secondary" onclick="toggleDebug()">üîß Debug</button>
            <button class="btn btn-primary" onclick="exportToJPG()">üì∑ JPG</button>
            <button class="btn btn-success" onclick="exportToPDF()">üìÑ PDF</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- ==================== LAT LON TOOLS PANEL ==================== -->
            <div class="latlon-tools-panel">
                <div class="section-title">üåê Lat Lon Tools</div>
                
                <div class="latlon-tools-tabs">
                    <button class="latlon-tab active" onclick="switchLatLonTab('capture')">üìç Capturar</button>
                    <button class="latlon-tab" onclick="switchLatLonTab('convert')">üîÑ Convertir</button>
                    <button class="latlon-tab" onclick="switchLatLonTab('zoom')">üîç Zoom</button>
                </div>

                <!-- Tab: Capture Coordinates -->
                <div id="latlon-capture" class="latlon-content active">
                    <div class="coord-display" id="capturedCoords">
                        <div class="coord-display-row">
                            <span class="coord-label">Lat, Lon (DD):</span>
                            <span class="coord-value" id="coord-dd" onclick="copyCoord('dd')" title="Clic para copiar">--.------, --.------</span>
                        </div>
                        <div class="coord-display-row">
                            <span class="coord-label">DMS:</span>
                            <span class="coord-value" id="coord-dms" onclick="copyCoord('dms')" title="Clic para copiar">--¬∞ --' --" N, --¬∞ --' --" W</span>
                        </div>
                        <div class="coord-display-row">
                            <span class="coord-label">UTM 17S:</span>
                            <span class="coord-value" id="coord-utm" onclick="copyCoord('utm')" title="Clic para copiar">-------, -------</span>
                        </div>
                    </div>
                    <div class="latlon-btn-group">
                        <button class="latlon-btn latlon-btn-primary" id="captureBtn" onclick="toggleCaptureMode()">
                            üìç Activar Captura
                        </button>
                        <button class="latlon-btn latlon-btn-success" onclick="copyAllCoords()">
                            üìã Copiar Todo
                        </button>
                    </div>
                </div>

                <!-- Tab: Coordinate Converter -->
                <div id="latlon-convert" class="latlon-content">
                    <select class="format-select" id="inputFormat" onchange="updateConverterPlaceholder()">
                        <option value="dd">Decimal Degrees (lat, lon)</option>
                        <option value="dms">DMS (¬∞ ' ")</option>
                        <option value="utm">UTM (X, Y)</option>
                    </select>
                    <input type="text" class="converter-input" id="converterInput" 
                           placeholder="Ej: -0.1807, -78.4678" 
                           onkeyup="convertCoordinates()">
                    <div class="converter-results" id="converterResults">
                        <div class="result-item">
                            <span class="result-label">Decimal:</span>
                            <span class="result-value" id="result-dd" onclick="copyResult('dd')">--</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">DMS:</span>
                            <span class="result-value" id="result-dms" onclick="copyResult('dms')">--</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">UTM 17S:</span>
                            <span class="result-value" id="result-utm" onclick="copyResult('utm')">--</span>
                        </div>
                    </div>
                    <div class="latlon-btn-group">
                        <button class="latlon-btn latlon-btn-primary" onclick="zoomToConverted()">
                            üîç Ir al Mapa
                        </button>
                    </div>
                </div>

                <!-- Tab: Zoom to Coordinates -->
                <div id="latlon-zoom" class="latlon-content">
                    <select class="format-select" id="zoomFormat">
                        <option value="dd">Decimal Degrees (lat, lon)</option>
                        <option value="dms">DMS (¬∞ ' ")</option>
                        <option value="utm">UTM (X, Y)</option>
                    </select>
                    <input type="text" class="converter-input" id="zoomInput" 
                           placeholder="Ingrese coordenadas..."
                           onkeydown="if(event.key==='Enter') zoomToCoordinate()">
                    <div class="latlon-btn-group">
                        <button class="latlon-btn latlon-btn-primary" onclick="zoomToCoordinate()">
                            üîç Zoom a Coordenada
                        </button>
                        <button class="latlon-btn latlon-btn-success" onclick="clearZoomMarker()">
                            üóëÔ∏è Limpiar Marcador
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìÅ Cargar Excel (Hoja RUTA)</div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xlsm,.xls">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">
                        <strong>Arrastra</strong> tu archivo Excel<br>
                        o <strong>haz clic</strong> para seleccionar
                    </div>
                </div>
                <div class="debug-panel" id="debugPanel"></div>
            </div>

            <div class="section" id="ieInfoSection" style="display:none;">
                <div class="ie-info">
                    <h3>üè´ IE Eje (Destino)</h3>
                    <p id="ieNombre">-</p>
                    <p id="ieAmie">AMIE: -</p>
                    <p id="ieDistrito">Distrito: -</p>
                    <p class="coords" id="ieCoords">Coordenadas: -</p>
                </div>
            </div>

            <div class="section">
                <div class="section-title">‚ûï Agregar Ruta Manual</div>
                <button class="btn btn-primary btn-block" onclick="openModal()">
                    üó∫Ô∏è Nueva Ruta
                </button>
            </div>

            <div class="section">
                <div class="section-title">
                    üìã Rutas (<span id="routeCount">0</span>)
                </div>
                <div class="route-list" id="routeList">
                    <div style="text-align:center; padding:25px; color:var(--text-muted);">
                        <div style="font-size:2rem; margin-bottom:8px;">üõ£Ô∏è</div>
                        <div>No hay rutas cargadas</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä Estad√≠sticas</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRoutes">0</div>
                        <div class="stat-label">Rutas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Estudiantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDistance">0</div>
                        <div class="stat-label">Km Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalIE">0</div>
                        <div class="stat-label">IE Origen</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-danger btn-block" onclick="clearAll()">
                    üóëÔ∏è Limpiar Todo
                </button>
            </div>
        </div>

        <div id="map"></div>
        
        <!-- Capture Mode Indicator -->
        <div class="capture-indicator" id="captureIndicator">üìç Modo Captura - Clic en el mapa</div>
    </div>

    <!-- Cursor Coordinates Bar -->
    <div class="cursor-coords-bar" id="cursorCoordsBar">
        <div class="cursor-coord-item">
            <span class="cursor-coord-label">DD:</span>
            <span class="cursor-coord-value" id="cursor-dd">--.------, --.------</span>
        </div>
        <div class="cursor-coord-item">
            <span class="cursor-coord-label">UTM:</span>
            <span class="cursor-coord-value" id="cursor-utm">-------, -------</span>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">üó∫Ô∏è Nueva Ruta</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>

            <form id="routeForm" onsubmit="addManualRoute(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">N√∫mero de Ruta *</label>
                        <input type="text" class="form-input" id="routeNumber" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Beneficiarios *</label>
                        <input type="number" class="form-input" id="routeBeneficiaries" required>
                    </div>
                </div>

                <div class="coord-section">
                    <div class="coord-section-title">üìç Origen (IE Fusionada/Comunidad)</div>
                    <div class="form-group">
                        <label class="form-label">C√≥digo AMIE</label>
                        <input type="text" class="form-input" id="originAmie">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coordenada X (UTM) *</label>
                            <input type="text" class="form-input" id="originX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordenada Y (UTM) *</label>
                            <input type="text" class="form-input" id="originY" required>
                        </div>
                    </div>
                </div>

                <div class="coord-section coord-dest">
                    <div class="coord-section-title">üè´ Destino (IE Eje) - Autocompletado</div>
                    <div class="form-group">
                        <label class="form-label">C√≥digo AMIE</label>
                        <input type="text" class="form-input" id="destAmie">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coordenada X *</label>
                            <input type="text" class="form-input" id="destX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coordenada Y *</label>
                            <input type="text" class="form-input" id="destY" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Distancia (Km)</label>
                        <input type="text" class="form-input" id="routeDistance">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transporte</label>
                        <select class="form-input" id="routeTransport">
                            <option value="BUS">Bus</option>
                            <option value="FURGONETA">Furgoneta</option>
                            <option value="CANOA">Canoa/Fluvial</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary btn-block" type="submit">‚úÖ Agregar Ruta</button>
            </form>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Procesando...</div>
    </div>

    <div class="notification" id="notification"></div>

    <div class="drawing-toolbar" id="drawingToolbar">
        <span id="drawingStatus">‚úèÔ∏è Dibujando</span>
        <span class="hint">Clic para agregar puntos</span>
        <button class="btn btn-secondary btn-sm" onclick="undoLastPoint()">‚Ü© Deshacer</button>
        <button class="btn btn-primary btn-sm" onclick="finishDrawing()">‚úÖ Finalizar</button>
        <button class="btn btn-danger btn-sm" onclick="cancelDrawing()">‚úï Cancelar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <script>
        // ==================== CONFIG ====================
        const CONFIG = {
            UTM_ZONE: 17,
            SOUTHERN_HEMISPHERE: false,
            DEFAULT_CENTER: [0.1, -79.2],
            DEFAULT_ZOOM: 10,
            OSRM_URL: 'https://router.project-osrm.org/route/v1/driving'
        };

        // ==================== VARIABLES ====================
        let map, routes = [], markers = [], polylines = [], ieEje = null;
        let drawingMode = false, drawingRouteId = null, drawingPolyline = null, drawingPoints = [];
        
        // Colores en tonos de ROJO para las rutas
        const routeColors = ['#ff0000', '#dc2626', '#b91c1c', '#991b1b', '#7f1d1d', '#ef4444', '#f87171', '#fca5a5', '#c81e1e', '#e53935'];

        // ==================== LAT LON TOOLS VARIABLES ====================
        let captureMode = false;
        let lastCapturedCoords = null;
        let lastConvertedCoords = null;
        let zoomMarker = null;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initFileUpload();
            initLatLonTools();
            log('Sistema listo - Lat Lon Tools integrado');
        });

        function initMap() {
            map = L.map('map').setView(CONFIG.DEFAULT_CENTER, CONFIG.DEFAULT_ZOOM);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | MINEDUC',
                maxZoom: 19
            }).addTo(map);
        }

        function initFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            uploadArea.onclick = () => fileInput.click();
            uploadArea.ondragover = (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); };
            uploadArea.ondragleave = () => uploadArea.classList.remove('dragover');
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
            };
            fileInput.onchange = (e) => { if (e.target.files[0]) processFile(e.target.files[0]); };
        }

        // ==================== LAT LON TOOLS FUNCTIONS ====================
        function initLatLonTools() {
            map.on('mousemove', updateCursorCoords);
            map.on('click', onMapClick);
        }

        function switchLatLonTab(tabId) {
            document.querySelectorAll('.latlon-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.latlon-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`latlon-${tabId}`).classList.add('active');
        }

        function updateCursorCoords(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            document.getElementById('cursor-dd').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            const utm = latLonToUtm(lat, lon);
            document.getElementById('cursor-utm').textContent = `${utm.x.toFixed(0)}, ${utm.y.toFixed(0)}`;
        }

        function toggleCaptureMode() {
            captureMode = !captureMode;
            const btn = document.getElementById('captureBtn');
            const indicator = document.getElementById('captureIndicator');
            const panel = document.querySelector('.latlon-tools-panel');
            
            if (captureMode) {
                btn.textContent = 'üî¥ Desactivar Captura';
                btn.style.background = 'rgba(239, 68, 68, 0.3)';
                btn.style.borderColor = '#ef4444';
                indicator.classList.add('show');
                panel.classList.add('capture-mode-active');
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = 'üìç Activar Captura';
                btn.style.background = '';
                btn.style.borderColor = '';
                indicator.classList.remove('show');
                panel.classList.remove('capture-mode-active');
                map.getContainer().style.cursor = '';
            }
        }

        function onMapClick(e) {
            if (!captureMode) return;
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            lastCapturedCoords = { lat, lon };
            document.getElementById('coord-dd').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            const dms = latLonToDMS(lat, lon);
            document.getElementById('coord-dms').textContent = dms;
            const utm = latLonToUtm(lat, lon);
            document.getElementById('coord-utm').textContent = `${utm.x.toFixed(2)}, ${utm.y.toFixed(2)}`;
            showNotification('üìç Coordenadas capturadas', 'success');
        }

        function copyCoord(format) {
            if (!lastCapturedCoords) {
                showNotification('‚ö†Ô∏è Primero captura una coordenada', 'error');
                return;
            }
            let text = '';
            const { lat, lon } = lastCapturedCoords;
            switch (format) {
                case 'dd': text = `${lat.toFixed(6)}, ${lon.toFixed(6)}`; break;
                case 'dms': text = latLonToDMS(lat, lon); break;
                case 'utm': const utm = latLonToUtm(lat, lon); text = `${utm.x.toFixed(2)}, ${utm.y.toFixed(2)}`; break;
            }
            navigator.clipboard.writeText(text);
            showNotification('üìã Copiado: ' + text, 'success');
        }

        function copyAllCoords() {
            if (!lastCapturedCoords) {
                showNotification('‚ö†Ô∏è Primero captura una coordenada', 'error');
                return;
            }
            const { lat, lon } = lastCapturedCoords;
            const utm = latLonToUtm(lat, lon);
            const dms = latLonToDMS(lat, lon);
            const text = `DD: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nDMS: ${dms}\nUTM: ${utm.x.toFixed(2)}, ${utm.y.toFixed(2)}`;
            navigator.clipboard.writeText(text);
            showNotification('üìã Todas las coordenadas copiadas', 'success');
        }

        function updateConverterPlaceholder() {
            const format = document.getElementById('inputFormat').value;
            const input = document.getElementById('converterInput');
            switch (format) {
                case 'dd': input.placeholder = 'Ej: -0.1807, -78.4678'; break;
                case 'dms': input.placeholder = "Ej: 0¬∞10'50\"S, 78¬∞28'4\"W"; break;
                case 'utm': input.placeholder = 'Ej: 772000, 9980000'; break;
            }
        }

        function convertCoordinates() {
            const format = document.getElementById('inputFormat').value;
            const input = document.getElementById('converterInput').value.trim();
            if (!input) { clearConverterResults(); return; }
            try {
                let lat, lon;
                switch (format) {
                    case 'dd':
                        const ddParts = input.split(/[,\s]+/).filter(p => p);
                        lat = parseFloat(ddParts[0]); lon = parseFloat(ddParts[1]); break;
                    case 'dms':
                        const coords = parseDMS(input); lat = coords.lat; lon = coords.lon; break;
                    case 'utm':
                        const utmParts = input.split(/[,\s]+/).filter(p => p);
                        const x = parseFloat(utmParts[0]); const y = parseFloat(utmParts[1]);
                        const ll = utmToLatLon(x, y); lat = ll.lat; lon = ll.lon; break;
                }
                if (isNaN(lat) || isNaN(lon)) throw new Error('Invalid');
                lastConvertedCoords = { lat, lon };
                document.getElementById('result-dd').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById('result-dms').textContent = latLonToDMS(lat, lon);
                const utm = latLonToUtm(lat, lon);
                document.getElementById('result-utm').textContent = `${utm.x.toFixed(2)}, ${utm.y.toFixed(2)}`;
            } catch (e) { clearConverterResults(); }
        }

        function clearConverterResults() {
            document.getElementById('result-dd').textContent = '--';
            document.getElementById('result-dms').textContent = '--';
            document.getElementById('result-utm').textContent = '--';
            lastConvertedCoords = null;
        }

        function copyResult(format) {
            if (!lastConvertedCoords) return;
            let text = '';
            const { lat, lon } = lastConvertedCoords;
            switch (format) {
                case 'dd': text = `${lat.toFixed(6)}, ${lon.toFixed(6)}`; break;
                case 'dms': text = latLonToDMS(lat, lon); break;
                case 'utm': const utm = latLonToUtm(lat, lon); text = `${utm.x.toFixed(2)}, ${utm.y.toFixed(2)}`; break;
            }
            navigator.clipboard.writeText(text);
            showNotification('üìã Copiado: ' + text, 'success');
        }

        function zoomToConverted() {
            if (!lastConvertedCoords) { showNotification('‚ö†Ô∏è Primero convierte una coordenada', 'error'); return; }
            const { lat, lon } = lastConvertedCoords;
            zoomToPoint(lat, lon);
        }

        function zoomToCoordinate() {
            const format = document.getElementById('zoomFormat').value;
            const input = document.getElementById('zoomInput').value.trim();
            if (!input) { showNotification('‚ö†Ô∏è Ingresa una coordenada', 'error'); return; }
            try {
                let lat, lon;
                switch (format) {
                    case 'dd':
                        const ddParts = input.split(/[,\s]+/).filter(p => p);
                        lat = parseFloat(ddParts[0]); lon = parseFloat(ddParts[1]); break;
                    case 'dms':
                        const coords = parseDMS(input); lat = coords.lat; lon = coords.lon; break;
                    case 'utm':
                        const utmParts = input.split(/[,\s]+/).filter(p => p);
                        const x = parseFloat(utmParts[0]); const y = parseFloat(utmParts[1]);
                        const ll = utmToLatLon(x, y); lat = ll.lat; lon = ll.lon; break;
                }
                if (isNaN(lat) || isNaN(lon)) throw new Error('Invalid');
                zoomToPoint(lat, lon);
            } catch (e) { showNotification('‚ùå Formato de coordenada inv√°lido', 'error'); }
        }

        function zoomToPoint(lat, lon) {
            if (zoomMarker) map.removeLayer(zoomMarker);
            const icon = L.divIcon({ className: 'zoom-marker', iconSize: [20, 20], iconAnchor: [10, 10] });
            zoomMarker = L.marker([lat, lon], { icon })
                .addTo(map)
                .bindPopup(`<b style="color:#fcd116">üìç Posici√≥n</b><br><small>Lat: ${lat.toFixed(6)}</small><br><small>Lon: ${lon.toFixed(6)}</small>`)
                .openPopup();
            map.setView([lat, lon], 15);
            showNotification('üîç Zoom a coordenada', 'success');
        }

        function clearZoomMarker() {
            if (zoomMarker) { map.removeLayer(zoomMarker); zoomMarker = null; showNotification('üóëÔ∏è Marcador eliminado', 'info'); }
        }

        // ==================== COORDINATE CONVERSION FUNCTIONS ====================
        function latLonToDMS(lat, lon) {
            const latDir = lat >= 0 ? 'N' : 'S';
            const lonDir = lon >= 0 ? 'E' : 'W';
            const latAbs = Math.abs(lat);
            const lonAbs = Math.abs(lon);
            const latDeg = Math.floor(latAbs);
            const latMin = Math.floor((latAbs - latDeg) * 60);
            const latSec = ((latAbs - latDeg) * 60 - latMin) * 60;
            const lonDeg = Math.floor(lonAbs);
            const lonMin = Math.floor((lonAbs - lonDeg) * 60);
            const lonSec = ((lonAbs - lonDeg) * 60 - lonMin) * 60;
            return `${latDeg}¬∞ ${latMin}' ${latSec.toFixed(2)}" ${latDir}, ${lonDeg}¬∞ ${lonMin}' ${lonSec.toFixed(2)}" ${lonDir}`;
        }

        function parseDMS(dmsStr) {
            const pattern = /(\d+)[¬∞\s]+(\d+)['\s]+(\d+\.?\d*)["\s]*([NSns])?[,\s]+(\d+)[¬∞\s]+(\d+)['\s]+(\d+\.?\d*)["\s]*([EWew])?/i;
            const match = dmsStr.match(pattern);
            if (!match) {
                const simplePattern = /(\d+\.?\d*)[,\s]+(\d+\.?\d*)/;
                const simpleMatch = dmsStr.match(simplePattern);
                if (simpleMatch) return { lat: parseFloat(simpleMatch[1]), lon: parseFloat(simpleMatch[2]) };
                throw new Error('Cannot parse DMS');
            }
            let lat = parseInt(match[1]) + parseInt(match[2]) / 60 + parseFloat(match[3]) / 3600;
            let lon = parseInt(match[5]) + parseInt(match[6]) / 60 + parseFloat(match[7]) / 3600;
            if (match[4] && match[4].toUpperCase() === 'S') lat = -lat;
            if (match[8] && match[8].toUpperCase() === 'W') lon = -lon;
            return { lat, lon };
        }

        function latLonToUtm(lat, lon) {
            const a = 6378137.0;
            const f = 1 / 298.257223563;
            const k0 = 0.9996;
            const e2 = 2 * f - f * f;
            const e = Math.sqrt(e2);
            const ePrime2 = e2 / (1 - e2);
            const latRad = lat * Math.PI / 180;
            const lonRad = lon * Math.PI / 180;
            const zone = CONFIG.UTM_ZONE;
            const lon0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;
            const N = a / Math.sqrt(1 - e2 * Math.sin(latRad) ** 2);
            const T = Math.tan(latRad) ** 2;
            const C = ePrime2 * Math.cos(latRad) ** 2;
            const A = Math.cos(latRad) * (lonRad - lon0);
            const M = a * (
                (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256) * latRad -
                (3*e2/8 + 3*e2*e2/32 + 45*e2*e2*e2/1024) * Math.sin(2*latRad) +
                (15*e2*e2/256 + 45*e2*e2*e2/1024) * Math.sin(4*latRad) -
                (35*e2*e2*e2/3072) * Math.sin(6*latRad)
            );
            const x = k0 * N * (A + (1-T+C)*A**3/6 + (5-18*T+T*T+72*C-58*ePrime2)*A**5/120) + 500000;
            const y = k0 * (M + N * Math.tan(latRad) * (A*A/2 + (5-T+9*C+4*C*C)*A**4/24 + (61-58*T+T*T+600*C-330*ePrime2)*A**6/720));
            const yFinal = lat < 0 ? y + 10000000 : y + 10000000;
            return { x, y: yFinal };
        }

        // ==================== DEBUG ====================
        function log(msg) {
            console.log(msg);
            const panel = document.getElementById('debugPanel');
            panel.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + panel.innerHTML;
        }

        function toggleDebug() { document.getElementById('debugPanel').classList.toggle('show'); }

        // ==================== UTM ‚Üí LAT/LON ====================
        function utmToLatLon(x, y) {
            const a = 6378137.0;
            const f = 1 / 298.257223563;
            const k0 = 0.9996;
            const e = Math.sqrt(2 * f - f * f);
            const e2 = e * e;
            const ePrime2 = e2 / (1 - e2);
            const xAdj = x - 500000;
            const yAdj = y - 10000000;
            const M = yAdj / k0;
            const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
            const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
            const phi1 = mu +
                (3*e1/2 - 27*Math.pow(e1,3)/32) * Math.sin(2*mu) +
                (21*e1*e1/16 - 55*Math.pow(e1,4)/32) * Math.sin(4*mu) +
                (151*Math.pow(e1,3)/96) * Math.sin(6*mu);
            const N1 = a / Math.sqrt(1 - e2 * Math.sin(phi1) ** 2);
            const T1 = Math.tan(phi1) ** 2;
            const C1 = ePrime2 * Math.cos(phi1) ** 2;
            const R1 = a * (1 - e2) / Math.pow(1 - e2 * Math.sin(phi1) ** 2, 1.5);
            const D = xAdj / (N1 * k0);
            let lat = phi1 - (N1 * Math.tan(phi1) / R1) *
                (D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*ePrime2) * Math.pow(D,4)/24 +
                (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*ePrime2 - 3*C1*C1) * Math.pow(D,6)/720);
            const lon0 = ((CONFIG.UTM_ZONE - 1) * 6 - 180 + 3) * Math.PI / 180;
            let lon = lon0 + (D - (1 + 2*T1 + C1) * Math.pow(D,3)/6 +
                (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*ePrime2 + 24*T1*T1) * Math.pow(D,5)/120) / Math.cos(phi1);
            return { lat: lat * 180 / Math.PI, lon: lon * 180 / Math.PI };
        }

        // ==================== EXCEL PROCESSING ====================
        async function processFile(file) {
            showLoading(true, 'Leyendo Excel...');
            try {
                log('Archivo: ' + file.name);
                const data = await readExcel(file);
                parseData(data);
                showNotification('‚úÖ Archivo cargado', 'success');
            } catch (err) {
                log('ERROR: ' + err.message);
                showNotification('‚ùå ' + err.message, 'error');
            } finally { showLoading(false); }
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const sheetName = wb.SheetNames.find(n => n.toUpperCase() === 'RUTA') || 
                                         wb.SheetNames.find(n => n.toUpperCase().includes('RUTA')) ||
                                         wb.SheetNames[1] || wb.SheetNames[0];
                        log('Usando hoja: ' + sheetName);
                        const sheet = wb.Sheets[sheetName];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = () => reject(new Error('Error leyendo archivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        function parseData(data) {
            ieEje = { nombre: '', amie: '', distrito: '', x: null, y: null };
            for (let i = 0; i < Math.min(15, data.length); i++) {
                const row = data[i];
                if (!row) continue;
                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toUpperCase().trim();
                    const nextVal = row[j + 1];
                    if (cell.includes('AMIE') && cell.includes('EJE') && !cell.includes('FUSIONADA')) {
                        if (nextVal) ieEje.amie = String(nextVal).trim();
                    }
                    if (cell.includes('NOMBRE') && cell.includes('UNIDAD') && cell.includes('EJE')) {
                        if (nextVal) ieEje.nombre = String(nextVal).trim();
                    }
                    if (cell.includes('NOMBRE DISTRITO')) {
                        if (nextVal) ieEje.distrito = String(nextVal).trim();
                    }
                    if (cell === 'COORDENADA X' || cell === 'COORDENADAS X') {
                        const val = parseFloat(nextVal);
                        if (!isNaN(val) && val > 100000 && val < 900000) { ieEje.x = val; log('IE Eje X: ' + val); }
                    }
                    if (cell === 'COORDENADA Y' || cell === 'COORDENADAS Y') {
                        const val = parseFloat(nextVal);
                        if (!isNaN(val) && val > 9000000 && val < 11000000) { ieEje.y = val; log('IE Eje Y: ' + val); }
                    }
                }
            }
            if (ieEje.amie || ieEje.x) {
                document.getElementById('ieInfoSection').style.display = 'block';
                document.getElementById('ieNombre').textContent = ieEje.nombre || '-';
                document.getElementById('ieAmie').textContent = 'AMIE: ' + (ieEje.amie || '-');
                document.getElementById('ieDistrito').textContent = ieEje.distrito || '-';
                if (ieEje.x && ieEje.y) {
                    const c = utmToLatLon(ieEje.x, ieEje.y);
                    document.getElementById('ieCoords').textContent = 
                        `UTM: ${ieEje.x.toFixed(2)}, ${ieEje.y.toFixed(2)} ‚Üí Lat: ${c.lat.toFixed(5)}, Lon: ${c.lon.toFixed(5)}`;
                    log('IE Eje LatLon: ' + c.lat.toFixed(5) + ', ' + c.lon.toFixed(5));
                }
            }
            let headerRow = -1;
            let colRuta = 0, colAmie = 2, colBenef = 3, colDist = 7, colX = 9, colY = 10;
            for (let i = 0; i < Math.min(20, data.length); i++) {
                const row = data[i];
                if (!row) continue;
                const rowStr = row.join('|').toUpperCase();
                if (rowStr.includes('RUTA') && rowStr.includes('COORDENADA X') && rowStr.includes('BENEFICIARIOS')) {
                    headerRow = i;
                    log('Encabezado en fila ' + (i + 1));
                    row.forEach((cell, idx) => {
                        const c = String(cell || '').toUpperCase().trim();
                        if (c === 'RUTA') colRuta = idx;
                        if (c.includes('AMIE') && (c.includes('FUSIONADA') || c.includes('COMUNIDAD'))) colAmie = idx;
                        if (c.includes('BENEFICIARIOS') && c.includes('RUTA')) colBenef = idx;
                        if (c.includes('DISTANCIA') && c.includes('RUTA')) colDist = idx;
                        if (c === 'COORDENADA X') colX = idx;
                        if (c === 'COORDENADA Y') colY = idx;
                    });
                    log(`Columnas: RUTA=${colRuta}, AMIE=${colAmie}, BENEF=${colBenef}, DIST=${colDist}, X=${colX}, Y=${colY}`);
                    break;
                }
            }
            if (headerRow === -1) { showNotification('‚ö†Ô∏è No encontr√© encabezado de rutas', 'error'); return; }
            clearRoutes();
            routes = [];
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[colRuta]) continue;
                const rutaNum = parseInt(row[colRuta]);
                if (isNaN(rutaNum)) continue;
                const xOrig = parseFloat(row[colX]);
                const yOrig = parseFloat(row[colY]);
                if (isNaN(xOrig) || isNaN(yOrig)) continue;
                if (xOrig < 100000 || xOrig > 900000) continue;
                if (yOrig < 9000000 || yOrig > 11000000) continue;
                const route = {
                    id: Date.now() + Math.random(),
                    numero: rutaNum,
                    amieFusionada: String(row[colAmie] || ''),
                    amieEje: ieEje.amie,
                    beneficiarios: parseInt(row[colBenef]) || 0,
                    distancia: parseFloat(row[colDist]) || 0,
                    origen: { x: xOrig, y: yOrig },
                    destino: { x: ieEje.x, y: ieEje.y },
                    mode: 'pending',
                    manualGeometry: null
                };
                routes.push(route);
                log(`Ruta ${rutaNum}: ${route.beneficiarios} estudiantes, ${xOrig.toFixed(0)},${yOrig.toFixed(0)}`);
            }
            log(`Total: ${routes.length} rutas`);
            if (routes.length === 0) { showNotification('‚ö†Ô∏è No se encontraron rutas', 'error'); return; }
            drawAllRoutes();
        }

        // ==================== DIBUJAR RUTAS ====================
        async function drawAllRoutes() {
            showLoading(true, 'Dibujando rutas...');
            for (let i = 0; i < routes.length; i++) {
                showLoading(true, `Ruta ${i + 1} de ${routes.length}...`);
                await drawRoute(routes[i]);
                await sleep(200);
            }
            showLoading(false);
            updateUI();
            centerMap();
            showNotification(`‚úÖ ${routes.length} rutas dibujadas`, 'success');
        }

        async function drawRoute(route) {
            const idx = routes.indexOf(route);
            const color = routeColors[idx % routeColors.length];
            const originLL = utmToLatLon(route.origen.x, route.origen.y);
            const originIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);color:#fff;">${route.numero}</div>`,
                iconSize: [26, 26], iconAnchor: [13, 13]
            });
            const originMarker = L.marker([originLL.lat, originLL.lon], { icon: originIcon })
                .bindPopup(`<b style="color:${color}">üìç Ruta ${route.numero} - Origen</b><br>AMIE: ${route.amieFusionada || '-'}<br>Estudiantes: ${route.beneficiarios}<br><small>UTM: ${route.origen.x.toFixed(0)}, ${route.origen.y.toFixed(0)}</small>`)
                .addTo(map);
            markers.push(originMarker);
            if (route.destino && route.destino.x && route.destino.y) {
                const destLL = utmToLatLon(route.destino.x, route.destino.y);
                const existsDest = markers.some(m => {
                    const p = m.getLatLng();
                    return Math.abs(p.lat - destLL.lat) < 0.0001 && Math.abs(p.lng - destLL.lon) < 0.0001;
                });
                if (!existsDest) {
                    const destIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:#10b981;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.4);">üè´</div>`,
                        iconSize: [34, 34], iconAnchor: [17, 17]
                    });
                    const destMarker = L.marker([destLL.lat, destLL.lon], { icon: destIcon })
                        .bindPopup(`<b style="color:#10b981">üè´ IE Eje - Destino</b><br>${ieEje.nombre || '-'}<br>AMIE: ${ieEje.amie || '-'}`)
                        .addTo(map);
                    markers.push(destMarker);
                }
                try {
                    const url = `${CONFIG.OSRM_URL}/${originLL.lon},${originLL.lat};${destLL.lon},${destLL.lat}?overview=full&geometries=geojson`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    if (data.routes && data.routes[0]) {
                        const coords = data.routes[0].geometry.coordinates.map(([lon, lat]) => [lat, lon]);
                        const distKm = (data.routes[0].distance / 1000).toFixed(2);
                        const durMin = Math.round(data.routes[0].duration / 60);
                        const polyline = L.polyline(coords, { color: color, weight: 7, opacity: 0.95 })
                            .bindPopup(`<b style="color:${color}">üöå Ruta ${route.numero}</b><br>Distancia: ${distKm} km<br>Tiempo: ~${durMin} min<br>Estudiantes: ${route.beneficiarios}`)
                            .addTo(map);
                        polylines.push(polyline);
                        route.distanciaCalculada = parseFloat(distKm);
                        route.mode = 'osrm';
                    } else { throw new Error('Sin ruta'); }
                } catch (err) {
                    const destLL = utmToLatLon(route.destino.x, route.destino.y);
                    const polyline = L.polyline([[originLL.lat, originLL.lon], [destLL.lat, destLL.lon]], {
                        color: color, weight: 4, opacity: 0.6, dashArray: '10, 10'
                    }).addTo(map);
                    polylines.push(polyline);
                    route.mode = 'line';
                }
            }
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // ==================== UI ====================
        function updateUI() {
            document.getElementById('routeCount').textContent = routes.length;
            document.getElementById('totalRoutes').textContent = routes.length;
            document.getElementById('totalStudents').textContent = routes.reduce((s, r) => s + r.beneficiarios, 0);
            document.getElementById('totalDistance').textContent = routes.reduce((s, r) => s + (r.distanciaCalculada || r.distancia || 0), 0).toFixed(1);
            document.getElementById('totalIE').textContent = new Set(routes.map(r => r.amieFusionada).filter(a => a)).size;
            const list = document.getElementById('routeList');
            if (routes.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:25px; color:var(--text-muted);"><div style="font-size:2rem; margin-bottom:8px;">üõ£Ô∏è</div><div>No hay rutas cargadas</div></div>`;
                return;
            }
            list.innerHTML = routes.map((r, i) => {
                const color = routeColors[i % routeColors.length];
                const modeLabel = r.mode === 'osrm' ? 'OSRM' : r.mode === 'manual' ? 'Manual' : r.mode === 'line' ? 'L√≠nea' : 'Pend.';
                return `<div class="route-item" onclick="focusRoute(${i})"><div class="route-header"><span class="route-number" style="color:${color}">üöå Ruta ${r.numero}</span><div style="display:flex;align-items:center;gap:6px;"><span class="route-mode-tag">${modeLabel}</span><button class="route-delete" onclick="event.stopPropagation();deleteRoute(${i})" title="Eliminar">üóëÔ∏è</button></div></div><div class="route-info"><span>üë• ${r.beneficiarios} estudiantes</span><span>üìè ${(r.distanciaCalculada || r.distancia || 0).toFixed(2)} km</span>${r.amieFusionada ? `<span>üè´ ${r.amieFusionada}</span>` : ''}</div></div>`;
            }).join('');
        }

        function focusRoute(idx) {
            const route = routes[idx];
            const ll = utmToLatLon(route.origen.x, route.origen.y);
            map.setView([ll.lat, ll.lon], 14);
        }

        function deleteRoute(idx) {
            if (!confirm('¬øEliminar esta ruta?')) return;
            routes.splice(idx, 1);
            redrawAll();
        }

        function redrawAll() { clearRoutes(); drawAllRoutes(); }

        function clearRoutes() {
            markers.forEach(m => map.removeLayer(m));
            polylines.forEach(p => map.removeLayer(p));
            markers = [];
            polylines = [];
        }

        function clearAll() {
            if (routes.length > 0 && !confirm('¬øLimpiar todas las rutas?')) return;
            routes = [];
            ieEje = null;
            clearRoutes();
            if (zoomMarker) { map.removeLayer(zoomMarker); zoomMarker = null; }
            document.getElementById('ieInfoSection').style.display = 'none';
            updateUI();
            showNotification('üóëÔ∏è Todo limpiado', 'info');
        }

        function centerMap() {
            if (markers.length === 0) return;
            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            map.fitBounds(bounds, { padding: [30, 30] });
        }

        // ==================== MODAL & MANUAL ROUTE ====================
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
            if (ieEje) {
                document.getElementById('destAmie').value = ieEje.amie || '';
                document.getElementById('destX').value = ieEje.x || '';
                document.getElementById('destY').value = ieEje.y || '';
            }
        }

        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

        async function addManualRoute(e) {
            e.preventDefault();
            const route = {
                id: Date.now(),
                numero: document.getElementById('routeNumber').value,
                amieFusionada: document.getElementById('originAmie').value,
                amieEje: document.getElementById('destAmie').value,
                beneficiarios: parseInt(document.getElementById('routeBeneficiaries').value) || 0,
                distancia: parseFloat(document.getElementById('routeDistance').value) || 0,
                origen: { x: parseFloat(document.getElementById('originX').value), y: parseFloat(document.getElementById('originY').value) },
                destino: { x: parseFloat(document.getElementById('destX').value), y: parseFloat(document.getElementById('destY').value) },
                transporte: document.getElementById('routeTransport').value,
                mode: 'osrm',
                manualGeometry: null
            };
            if (isNaN(route.origen.x) || isNaN(route.origen.y)) { showNotification('‚ùå Coordenadas inv√°lidas', 'error'); return; }
            routes.push(route);
            showLoading(true, 'Calculando...');
            await drawRoute(route);
            showLoading(false);
            updateUI();
            closeModal();
            centerMap();
            document.getElementById('routeForm').reset();
        }

        // ==================== DRAWING MODE ====================
        function startDrawing(routeId) {
            drawingMode = true;
            drawingRouteId = routeId;
            drawingPoints = [];
            document.getElementById('drawingToolbar').style.display = 'flex';
            map.getContainer().style.cursor = 'crosshair';
        }

        function undoLastPoint() {
            if (drawingPoints.length > 0) { drawingPoints.pop(); updateDrawingPolyline(); }
        }

        function updateDrawingPolyline() {
            if (drawingPolyline) map.removeLayer(drawingPolyline);
            if (drawingPoints.length > 1) { drawingPolyline = L.polyline(drawingPoints, { color: '#fcd116', weight: 5 }).addTo(map); }
        }

        function finishDrawing() {
            if (drawingPoints.length < 2) { showNotification('‚ö†Ô∏è Necesitas al menos 2 puntos', 'error'); return; }
            const route = routes.find(r => r.id === drawingRouteId);
            if (route) { route.manualGeometry = drawingPoints; route.mode = 'manual'; }
            cancelDrawing();
            redrawAll();
        }

        function cancelDrawing() {
            drawingMode = false;
            drawingRouteId = null;
            drawingPoints = [];
            if (drawingPolyline) { map.removeLayer(drawingPolyline); drawingPolyline = null; }
            document.getElementById('drawingToolbar').style.display = 'none';
            map.getContainer().style.cursor = '';
        }

        // ==================== EXPORT ====================
        async function captureMap() {
            const mapEl = document.getElementById('map');
            await new Promise(r => setTimeout(r, 500));
            try {
                const dataUrl = await domtoimage.toJpeg(mapEl, { quality: 0.95, bgcolor: '#ffffff', style: { 'transform': 'none' } });
                return dataUrl;
            } catch (err) {
                console.log('dom-to-image fall√≥, usando html2canvas:', err);
                const canvas = await html2canvas(mapEl, { useCORS: true, scale: 2, logging: false, allowTaint: true });
                return canvas.toDataURL('image/jpeg', 0.95);
            }
        }

        async function exportToJPG() {
            showLoading(true, 'Capturando mapa...');
            try {
                const dataUrl = await captureMap();
                const link = document.createElement('a');
                link.download = `rutas_${ieEje?.amie || 'mapa'}_${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = dataUrl;
                link.click();
                showNotification('üì∑ JPG exportado', 'success');
            } catch (err) { showNotification('Error: ' + err.message, 'error'); }
            finally { showLoading(false); }
        }

        async function exportToPDF() {
            showLoading(true, 'Generando PDF...');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                // Bandera Ecuador
                doc.setFillColor(252, 209, 22); doc.rect(0, 0, 297, 8, 'F');
                doc.setFillColor(0, 56, 147); doc.rect(0, 8, 297, 3, 'F');
                doc.setFillColor(206, 17, 38); doc.rect(0, 11, 297, 2, 'F');
                
                // Logo institucional (si existe) - CENTRADO
                try {
                    // Logo: 903x82px = 11:1 ratio
                    // CENTRADO: 160mm ancho x 14.5mm alto
                    doc.addImage('logo.png', 'PNG', 68.5, 15, 160, 14.5);
                } catch(e) { console.log('Logo no disponible en PDF'); }
                
                // Texto institucional debajo del logo
                doc.setFontSize(10);
                doc.setTextColor(139, 69, 19); // Color caf√©/dorado
                doc.setFont(undefined, 'normal');
                doc.text('Ministerio de Educaci√≥n Deporte y Cultura (MINEDEC)', 148.5, 32, { align: 'center' });
                
                // T√≠tulo principal
                doc.setFontSize(16);
                doc.setTextColor(0, 56, 147);
                doc.setFont(undefined, 'bold');
                doc.text('INFORME DE RUTAS DE TRANSPORTE ESCOLAR', 148.5, 40, { align: 'center' });
                
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.setFont(undefined, 'normal');
                doc.text('', 148.5, 46, { align: 'center' });
                
                let y = 54;
                
                // Informaci√≥n IE Eje
                if (ieEje?.amie) {
                    doc.setFontSize(11);
                    doc.setTextColor(0);
                    doc.setFont(undefined, 'bold');
                    doc.text('IE Eje:', 20, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${ieEje.nombre || '-'} (AMIE: ${ieEje.amie})`, 45, y);
                    y += 6;
                    doc.text(`Distrito: ${ieEje.distrito || '-'}`, 20, y);
                }
                
                // Resumen
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Resumen:', 20, y);
                doc.setFont(undefined, 'normal');
                y += 6;
                doc.text(`Rutas: ${routes.length} | Estudiantes: ${routes.reduce((s,r) => s + r.beneficiarios, 0)} | Distancia total: ${routes.reduce((s,r) => s + (r.distanciaCalculada || r.distancia || 0), 0).toFixed(2)} km`, 20, y);
                
                // T√≠tulo del mapa
                y += 12;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 56, 147);
                doc.text('MAPA DE RUTAS DE TRANSPORTE ESCOLAR DE LA', 148.5, y, { align: 'center' });
                y += 6;
                doc.setFontSize(11);
                doc.text(`${ieEje?.nombre || 'SIN NOMBRE'}`, 148.5, y, { align: 'center' });
                doc.setFont(undefined, 'normal');
                
                // Capturar mapa
                y += 8;
                showLoading(true, 'Capturando mapa para PDF...');
                const mapDataUrl = await captureMap();
                // Mapa centrado: (297 - 200) / 2 = 48.5mm
                doc.addImage(mapDataUrl, 'JPEG', 48.5, y, 200, 100);
                y += 105;
                
                // Tabla de rutas
                function drawTableHeader(yPos) {
                    doc.setFillColor(0, 56, 147);
                    doc.setTextColor(255);
                    doc.rect(20, yPos - 4, 257, 7, 'F');
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text('Ruta', 25, yPos);
                    doc.text('AMIE Origen', 45, yPos);
                    doc.text('Estudiantes', 105, yPos);
                    doc.text('Dist. Excel', 135, yPos);
                    doc.text('Dist. Calc.', 165, yPos);
                    doc.text('Modo', 200, yPos);
                    doc.text('Transporte', 230, yPos);
                    return yPos + 6;
                }
                
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Detalle de Rutas:', 20, y);
                y += 6;
                y = drawTableHeader(y);
                doc.setTextColor(0);
                doc.setFont(undefined, 'normal');
                
                const pageHeight = 200;
                routes.forEach((r, i) => {
                    if (y > pageHeight) {
                        doc.addPage();
                        y = 20;
                        doc.setFillColor(252, 209, 22); doc.rect(0, 0, 297, 5, 'F');
                        doc.setFillColor(0, 56, 147); doc.rect(0, 5, 297, 2, 'F');
                        doc.setFillColor(206, 17, 38); doc.rect(0, 7, 297, 1, 'F');
                        y = 15;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 56, 147);
                        doc.text('Detalle de Rutas (continuaci√≥n)', 20, y);
                        y += 8;
                        y = drawTableHeader(y);
                        doc.setTextColor(0);
                        doc.setFont(undefined, 'normal');
                    }
                    if (i % 2 === 0) { doc.setFillColor(245, 245, 245); doc.rect(20, y - 3, 257, 6, 'F'); }
                    doc.setFontSize(8);
                    doc.text(String(r.numero), 25, y);
                    doc.text(String(r.amieFusionada || '-').substring(0, 20), 45, y);
                    doc.text(String(r.beneficiarios), 110, y);
                    doc.text((r.distancia || 0).toFixed(2), 138, y);
                    doc.text((r.distanciaCalculada || 0).toFixed(2), 168, y);
                    doc.text(r.mode === 'manual' ? 'Manual' : r.mode === 'osrm' ? 'OSRM' : 'L√≠nea', 200, y);
                    doc.text(r.transporte || 'Bus', 230, y);
                    y += 6;
                });
                
                // Pie de p√°gina
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Generado: ${new Date().toLocaleString('es-EC')} | P√°gina ${i} de ${pageCount}`, 148.5, 205, { align: 'center' });
                }
                
                doc.save(`informe_rutas_${ieEje?.amie || 'export'}_${new Date().toISOString().slice(0,10)}.pdf`);
                showNotification('üìÑ PDF generado', 'success');
            } catch (err) { 
                console.error(err);
                showNotification('Error: ' + err.message, 'error'); 
            }
            finally { showLoading(false); }
        }

        // ==================== UTILS ====================
        function showLoading(show, text = 'Procesando...') {
            document.getElementById('loading').classList.toggle('show', show);
            document.getElementById('loadingText').textContent = text;
        }

        function showNotification(msg, type = 'info') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove('show'), 4000);
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeModal(); cancelDrawing(); if (captureMode) toggleCaptureMode(); }
        });
    </script>
</body>
</html>
